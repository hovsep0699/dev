{"ast":null,"code":"import _objectWithoutProperties from\"C:\\\\Users\\\\Hovsep\\\\Desktop\\\\local\\\\diflow_react\\\\node_modules\\\\babel-preset-react-app\\\\node_modules\\\\@babel\\\\runtime/helpers/esm/objectWithoutProperties\";import _regeneratorRuntime from\"C:\\\\Users\\\\Hovsep\\\\Desktop\\\\local\\\\diflow_react\\\\node_modules\\\\babel-preset-react-app\\\\node_modules\\\\@babel\\\\runtime/regenerator\";var _marked=/*#__PURE__*/_regeneratorRuntime.mark(financeEffect),_marked2=/*#__PURE__*/_regeneratorRuntime.mark(getFinanceInfoWorker),_marked3=/*#__PURE__*/_regeneratorRuntime.mark(changeBalanceWorker),_marked4=/*#__PURE__*/_regeneratorRuntime.mark(setBillWorker),_marked5=/*#__PURE__*/_regeneratorRuntime.mark(getTariffsWorker),_marked6=/*#__PURE__*/_regeneratorRuntime.mark(getTariffFlowWorker),_marked7=/*#__PURE__*/_regeneratorRuntime.mark(changeTariffWorker),_marked8=/*#__PURE__*/_regeneratorRuntime.mark(getTariffsByCompanyIdWorker),_marked9=/*#__PURE__*/_regeneratorRuntime.mark(getTransactionsHistoryWorker),_marked10=/*#__PURE__*/_regeneratorRuntime.mark(getTariffCardWorker);import{takeLatest,put}from'redux-saga/effects';import{financeGateway}from'@distate/core/dist/application/finance/FinanceGateway';import AuthGateway from'@distate/core/dist/application/auth/AuthGateway';import CompanyGateway from'@distate/core/dist/application/company/CompanyGateway';import{Flash}from'../../../../common/flash/Flash';import{getFinanceInfo,setFinanceInfo,changeBalance,setBill,getTariffs,getTariffFlow,changeTariff,getTariffsByCompanyId,setTariffsByCompanyId,getTransactionsHistory,setTransactionsHistory,getTariffCard,setTariff}from'../actions';import{history}from'../../../../App';/** Финансы */export function financeEffect(){return _regeneratorRuntime.wrap(function financeEffect$(_context){while(1){switch(_context.prev=_context.next){case 0:_context.next=2;return takeLatest(getFinanceInfo,getFinanceInfoWorker);case 2:_context.next=4;return takeLatest(changeBalance,changeBalanceWorker);case 4:_context.next=6;return takeLatest(setBill,setBillWorker);case 6:_context.next=8;return takeLatest(getTariffs,getTariffsWorker);case 8:_context.next=10;return takeLatest(getTariffFlow,getTariffFlowWorker);case 10:_context.next=12;return takeLatest(changeTariff,changeTariffWorker);case 12:_context.next=14;return takeLatest(getTariffsByCompanyId,getTariffsByCompanyIdWorker);case 14:_context.next=16;return takeLatest(getTransactionsHistory,getTransactionsHistoryWorker);case 16:_context.next=18;return takeLatest(getTariffCard,getTariffCardWorker);case 18:case\"end\":return _context.stop();}}},_marked);}function getFinanceInfoWorker(_ref){var payload,_tariffResponse$rows,_currentTariffInfo$pr,_allTariff$rows,authGateway,companyGateway,selectedCompany,currentUser,balanceResponse,tariffResponse,currentTariff,currentTariffInfo,isPromotion,allTariff,findedTariff,tariffBalance,balance,accountNumber,isVks,companyName,props,_response$data,response;return _regeneratorRuntime.wrap(function getFinanceInfoWorker$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:payload=_ref.payload;_context2.prev=1;authGateway=new AuthGateway();companyGateway=new CompanyGateway();_context2.next=6;return companyGateway.getCompanyJson(payload);case 6:selectedCompany=_context2.sent;_context2.next=9;return authGateway.currentUser();case 9:currentUser=_context2.sent;_context2.next=12;return financeGateway.getBalance(payload);case 12:balanceResponse=_context2.sent;_context2.next=15;return financeGateway.getTariffsByCompanyId(payload);case 15:tariffResponse=_context2.sent;currentTariff=tariffResponse===null||tariffResponse===void 0?void 0:(_tariffResponse$rows=tariffResponse.rows)===null||_tariffResponse$rows===void 0?void 0:_tariffResponse$rows.find(function(item){return(item===null||item===void 0?void 0:item.next_id)===null;});_context2.next=19;return financeGateway.getTariff(currentTariff===null||currentTariff===void 0?void 0:currentTariff.tariff_id);case 19:currentTariffInfo=_context2.sent;isPromotion=currentTariffInfo===null||currentTariffInfo===void 0?void 0:(_currentTariffInfo$pr=currentTariffInfo.pricing)===null||_currentTariffInfo$pr===void 0?void 0:_currentTariffInfo$pr.isPromotion;currentTariff.isPromotion=isPromotion;_context2.next=24;return financeGateway.getTariffs({});case 24:allTariff=_context2.sent;/** предоплата или постоплата */findedTariff=allTariff===null||allTariff===void 0?void 0:(_allTariff$rows=allTariff.rows)===null||_allTariff$rows===void 0?void 0:_allTariff$rows.find(function(item){return(item===null||item===void 0?void 0:item.id)===(currentTariff===null||currentTariff===void 0?void 0:currentTariff.tariff_id);});_context2.next=28;return financeGateway.getTariffBalance(currentTariff.id);case 28:tariffBalance=_context2.sent;balance=balanceResponse.balance,accountNumber=balanceResponse.number;isVks=currentUser.roles.includes('ROLE_CNO');companyName=selectedCompany.name;props={isVks:isVks,companyName:companyName,balance:balance,accountNumber:accountNumber,currentTariff:currentTariff,isPostpaid:(findedTariff===null||findedTariff===void 0?void 0:findedTariff.type_system_name)==='postpaid',tariffBalance:tariffBalance===null||tariffBalance===void 0?void 0:tariffBalance.balance,authorized:tariffBalance===null||tariffBalance===void 0?void 0:tariffBalance.authorized};_context2.next=35;return put(setFinanceInfo(props));case 35:_context2.next=42;break;case 37:_context2.prev=37;_context2.t0=_context2[\"catch\"](1);response=_context2.t0.response;_context2.next=42;return Flash.error((response===null||response===void 0?void 0:(_response$data=response.data)===null||_response$data===void 0?void 0:_response$data.messages[0])||'Возникла ошибка');case 42:case\"end\":return _context2.stop();}}},_marked2,null,[[1,37]]);}/** изменение баланса */function changeBalanceWorker(_ref3){var payload,id,sum,comment,hide,formData,_response$data2,_response$data2$messa,response;return _regeneratorRuntime.wrap(function changeBalanceWorker$(_context3){while(1){switch(_context3.prev=_context3.next){case 0:payload=_ref3.payload;_context3.prev=1;id=payload.id,sum=payload.sum,comment=payload.comment,hide=payload.hide;formData=new FormData();formData.append('sum',String(sum));formData.append('comment',comment);_context3.next=8;return financeGateway.setBalance(id,formData);case 8:_context3.next=10;return put(getFinanceInfo(id));case 10:hide();_context3.next=18;break;case 13:_context3.prev=13;_context3.t0=_context3[\"catch\"](1);response=_context3.t0.response;_context3.next=18;return Flash.error((response===null||response===void 0?void 0:(_response$data2=response.data)===null||_response$data2===void 0?void 0:(_response$data2$messa=_response$data2.messages)===null||_response$data2$messa===void 0?void 0:_response$data2$messa.sum)||'Возникла ошибка');case 18:case\"end\":return _context3.stop();}}},_marked3,null,[[1,13]]);}/** выставление счета */function setBillWorker(_ref5){var payload,id,sum,formData,_yield$financeGateway,data,_response$data3,response;return _regeneratorRuntime.wrap(function setBillWorker$(_context4){while(1){switch(_context4.prev=_context4.next){case 0:payload=_ref5.payload;_context4.prev=1;id=payload.id,sum=payload.sum;formData=new FormData();formData.append('sum',String(sum));_context4.next=7;return financeGateway.setBill(id,formData);case 7:_yield$financeGateway=_context4.sent;data=_yield$financeGateway.data;_context4.next=11;return history.push(\"/document/\".concat(data.id));case 11:_context4.next=18;break;case 13:_context4.prev=13;_context4.t0=_context4[\"catch\"](1);response=_context4.t0.response;_context4.next=18;return Flash.error((response===null||response===void 0?void 0:(_response$data3=response.data)===null||_response$data3===void 0?void 0:_response$data3.messages[0])||'Возникла ошибка');case 18:case\"end\":return _context4.stop();}}},_marked4,null,[[1,13]]);}/** получение списка тарифов */function getTariffsWorker(_ref7){var payload,tariffs,_response$data4,response;return _regeneratorRuntime.wrap(function getTariffsWorker$(_context5){while(1){switch(_context5.prev=_context5.next){case 0:payload=_ref7.payload;_context5.prev=1;_context5.next=4;return financeGateway.getTariffs(payload);case 4:tariffs=_context5.sent;_context5.next=7;return put(setFinanceInfo({tariffs:tariffs}));case 7:_context5.next=14;break;case 9:_context5.prev=9;_context5.t0=_context5[\"catch\"](1);response=_context5.t0.response;_context5.next=14;return Flash.error((response===null||response===void 0?void 0:(_response$data4=response.data)===null||_response$data4===void 0?void 0:_response$data4.messages[0])||'Возникла ошибка');case 14:case\"end\":return _context5.stop();}}},_marked5,null,[[1,9]]);}/** получение документооборот тарифа */function getTariffFlowWorker(_ref9){var payload,tariffFlow,_response$data5,response;return _regeneratorRuntime.wrap(function getTariffFlowWorker$(_context6){while(1){switch(_context6.prev=_context6.next){case 0:payload=_ref9.payload;_context6.prev=1;_context6.next=4;return financeGateway.getTariffFlow(payload);case 4:tariffFlow=_context6.sent;_context6.next=7;return put(setFinanceInfo({tariffFlow:tariffFlow}));case 7:_context6.next=14;break;case 9:_context6.prev=9;_context6.t0=_context6[\"catch\"](1);response=_context6.t0.response;_context6.next=14;return Flash.error((response===null||response===void 0?void 0:(_response$data5=response.data)===null||_response$data5===void 0?void 0:_response$data5.messages[0])||'Возникла ошибка');case 14:case\"end\":return _context6.stop();}}},_marked6,null,[[1,9]]);}/** изменить тариф */function changeTariffWorker(_ref11){var payload,id,tariffId,formData,_response$data6,response;return _regeneratorRuntime.wrap(function changeTariffWorker$(_context7){while(1){switch(_context7.prev=_context7.next){case 0:payload=_ref11.payload;_context7.prev=1;id=payload.id,tariffId=payload.tariffId;formData=new FormData();formData.append('tariff',String(tariffId));_context7.next=7;return financeGateway.changeTariff(id,formData);case 7:_context7.next=9;return put(getFinanceInfo(id));case 9:_context7.next=11;return Flash.success('Настроки сохранены');case 11:_context7.next=18;break;case 13:_context7.prev=13;_context7.t0=_context7[\"catch\"](1);response=_context7.t0.response;_context7.next=18;return Flash.error((response===null||response===void 0?void 0:(_response$data6=response.data)===null||_response$data6===void 0?void 0:_response$data6.messages[0])||'Возникла ошибка');case 18:case\"end\":return _context7.stop();}}},_marked7,null,[[1,13]]);}/** получить историю тарифов по id компании */function getTariffsByCompanyIdWorker(_ref13){var payload,id,params,response,_response$data7,_response;return _regeneratorRuntime.wrap(function getTariffsByCompanyIdWorker$(_context8){while(1){switch(_context8.prev=_context8.next){case 0:payload=_ref13.payload;_context8.prev=1;id=payload.id,params=payload.params;_context8.next=5;return financeGateway.getTariffsByCompanyId(id,params);case 5:response=_context8.sent;_context8.next=8;return put(setTariffsByCompanyId({tariffsHistory:response}));case 8:_context8.next=15;break;case 10:_context8.prev=10;_context8.t0=_context8[\"catch\"](1);_response=_context8.t0.response;_context8.next=15;return Flash.error((_response===null||_response===void 0?void 0:(_response$data7=_response.data)===null||_response$data7===void 0?void 0:_response$data7.messages[0])||'Возникла ошибка');case 15:case\"end\":return _context8.stop();}}},_marked8,null,[[1,10]]);}/** получить историю транзакций */function getTransactionsHistoryWorker(_ref15){var payload,id,params,response,_response2$data,_response2;return _regeneratorRuntime.wrap(function getTransactionsHistoryWorker$(_context9){while(1){switch(_context9.prev=_context9.next){case 0:payload=_ref15.payload;_context9.prev=1;id=payload.id,params=_objectWithoutProperties(payload,[\"id\"]);_context9.next=5;return financeGateway.getTransactionsHistory(id,params);case 5:response=_context9.sent;_context9.next=8;return put(setTransactionsHistory({transactionsHistory:response}));case 8:_context9.next=15;break;case 10:_context9.prev=10;_context9.t0=_context9[\"catch\"](1);_response2=_context9.t0.response;_context9.next=15;return Flash.error((_response2===null||_response2===void 0?void 0:(_response2$data=_response2.data)===null||_response2$data===void 0?void 0:_response2$data.messages[0])||'Возникла ошибка');case 15:case\"end\":return _context9.stop();}}},_marked9,null,[[1,10]]);}/** получить карточку тарифа */function getTariffCardWorker(_ref17){var payload,selectedTariff,response;return _regeneratorRuntime.wrap(function getTariffCardWorker$(_context10){while(1){switch(_context10.prev=_context10.next){case 0:payload=_ref17.payload;_context10.prev=1;_context10.next=4;return put(getTariffFlow(payload));case 4:_context10.next=6;return financeGateway.getTariff(payload);case 6:selectedTariff=_context10.sent;_context10.next=9;return put(setTariff({selectedTariff:selectedTariff}));case 9:_context10.next=16;break;case 11:_context10.prev=11;_context10.t0=_context10[\"catch\"](1);response=_context10.t0.response;_context10.next=16;return Flash.error('Возникла ошибка');case 16:case\"end\":return _context10.stop();}}},_marked10,null,[[1,11]]);}","map":{"version":3,"sources":["C:/Users/Hovsep/Desktop/local/diflow_react/packages/app/src/pages/finance/store/sagas/finance.effect.ts"],"names":["financeEffect","getFinanceInfoWorker","changeBalanceWorker","setBillWorker","getTariffsWorker","getTariffFlowWorker","changeTariffWorker","getTariffsByCompanyIdWorker","getTransactionsHistoryWorker","getTariffCardWorker","takeLatest","put","financeGateway","AuthGateway","CompanyGateway","Flash","getFinanceInfo","setFinanceInfo","changeBalance","setBill","getTariffs","getTariffFlow","changeTariff","getTariffsByCompanyId","setTariffsByCompanyId","getTransactionsHistory","setTransactionsHistory","getTariffCard","setTariff","history","payload","authGateway","companyGateway","getCompanyJson","selectedCompany","currentUser","getBalance","balanceResponse","tariffResponse","currentTariff","rows","find","item","next_id","getTariff","tariff_id","currentTariffInfo","isPromotion","pricing","allTariff","findedTariff","id","getTariffBalance","tariffBalance","balance","accountNumber","number","isVks","roles","includes","companyName","name","props","isPostpaid","type_system_name","authorized","response","error","data","messages","sum","comment","hide","formData","FormData","append","String","setBalance","push","tariffs","tariffFlow","tariffId","success","params","tariffsHistory","transactionsHistory","selectedTariff"],"mappings":"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","sourcesContent":["import { takeLatest, put } from 'redux-saga/effects';\r\nimport { financeGateway } from '@distate/core/dist/application/finance/FinanceGateway';\r\nimport AuthGateway from '@distate/core/dist/application/auth/AuthGateway';\r\nimport CompanyGateway from '@distate/core/dist/application/company/CompanyGateway';\r\n\r\nimport { Flash } from '../../../../common/flash/Flash';\r\nimport {\r\n  getFinanceInfo,\r\n  setFinanceInfo,\r\n  changeBalance,\r\n  setBill,\r\n  getTariffs,\r\n  getTariffFlow,\r\n  changeTariff,\r\n  getTariffsByCompanyId,\r\n  setTariffsByCompanyId,\r\n  getTransactionsHistory,\r\n  setTransactionsHistory,\r\n  getTariffCard,\r\n  setTariff\r\n} from '../actions';\r\nimport { history } from '../../../../App';\r\n\r\n/** Финансы */\r\nexport function* financeEffect() {\r\n  yield takeLatest(getFinanceInfo, getFinanceInfoWorker);\r\n  yield takeLatest(changeBalance, changeBalanceWorker);\r\n  yield takeLatest(setBill, setBillWorker);\r\n  yield takeLatest(getTariffs, getTariffsWorker);\r\n  yield takeLatest(getTariffFlow, getTariffFlowWorker);\r\n  yield takeLatest(changeTariff, changeTariffWorker);\r\n  yield takeLatest(getTariffsByCompanyId, getTariffsByCompanyIdWorker);\r\n  yield takeLatest(getTransactionsHistory, getTransactionsHistoryWorker);\r\n  yield takeLatest(getTariffCard, getTariffCardWorker);\r\n}\r\n\r\nfunction* getFinanceInfoWorker({ payload }: { payload: number }) {\r\n  try {\r\n    const authGateway = new AuthGateway();\r\n    const companyGateway = new CompanyGateway();\r\n\r\n    const selectedCompany = yield companyGateway.getCompanyJson(payload);\r\n\r\n    const currentUser = yield authGateway.currentUser();\r\n    const balanceResponse = yield financeGateway.getBalance(payload);\r\n    const tariffResponse = yield financeGateway.getTariffsByCompanyId(payload);\r\n    const currentTariff = tariffResponse?.rows?.find((item: any) => item?.next_id === null);\r\n    const currentTariffInfo = yield financeGateway.getTariff(currentTariff?.tariff_id);\r\n    const isPromotion = currentTariffInfo?.pricing?.isPromotion;\r\n    currentTariff.isPromotion = isPromotion;\r\n\r\n    const allTariff = yield financeGateway.getTariffs({});\r\n    /** предоплата или постоплата */\r\n    const findedTariff = allTariff?.rows?.find(\r\n      (item: any) => item?.id === currentTariff?.tariff_id\r\n    );\r\n\r\n    const tariffBalance = yield financeGateway.getTariffBalance(currentTariff.id);\r\n\r\n    const { balance, number: accountNumber } = balanceResponse;\r\n    const isVks = currentUser.roles.includes('ROLE_CNO');\r\n    const companyName = selectedCompany.name;\r\n\r\n    const props: {} = {\r\n      isVks,\r\n      companyName,\r\n      balance,\r\n      accountNumber,\r\n      currentTariff,\r\n      isPostpaid: findedTariff?.type_system_name === 'postpaid',\r\n      tariffBalance: tariffBalance?.balance,\r\n      authorized: tariffBalance?.authorized\r\n    };\r\n\r\n    yield put(setFinanceInfo(props));\r\n  } catch ({ response }) {\r\n    yield Flash.error(response?.data?.messages[0] || 'Возникла ошибка');\r\n  }\r\n}\r\n\r\ntype ChangeBalance = {\r\n  id: number;\r\n  sum: number;\r\n  comment: string;\r\n  hide: () => void;\r\n};\r\n/** изменение баланса */\r\nfunction* changeBalanceWorker({ payload }: { payload: ChangeBalance }) {\r\n  try {\r\n    const { id, sum, comment, hide } = payload;\r\n\r\n    const formData = new FormData();\r\n    formData.append('sum', String(sum));\r\n    formData.append('comment', comment);\r\n\r\n    yield financeGateway.setBalance(id, formData);\r\n    yield put(getFinanceInfo(id));\r\n    hide();\r\n  } catch ({ response }) {\r\n    yield Flash.error(response?.data?.messages?.sum || 'Возникла ошибка');\r\n  }\r\n}\r\n\r\ntype SetBill = {\r\n  id: number;\r\n  sum: number;\r\n};\r\n/** выставление счета */\r\nfunction* setBillWorker({ payload }: { payload: SetBill }) {\r\n  try {\r\n    const { id, sum } = payload;\r\n\r\n    const formData = new FormData();\r\n    formData.append('sum', String(sum));\r\n\r\n    const { data } = yield financeGateway.setBill(id, formData);\r\n    yield history.push(`/document/${data.id}`);\r\n  } catch ({ response }) {\r\n    yield Flash.error(response?.data?.messages[0] || 'Возникла ошибка');\r\n  }\r\n}\r\n\r\ntype GetTariffs = {\r\n  offset: number;\r\n  notStatusSystemName: string;\r\n};\r\n/** получение списка тарифов */\r\nfunction* getTariffsWorker({ payload }: { payload: GetTariffs }) {\r\n  try {\r\n    const tariffs = yield financeGateway.getTariffs(payload);\r\n    yield put(setFinanceInfo({ tariffs }));\r\n  } catch ({ response }) {\r\n    yield Flash.error(response?.data?.messages[0] || 'Возникла ошибка');\r\n  }\r\n}\r\n\r\n/** получение документооборот тарифа */\r\nfunction* getTariffFlowWorker({ payload }: { payload: number }) {\r\n  try {\r\n    const tariffFlow = yield financeGateway.getTariffFlow(payload);\r\n    yield put(setFinanceInfo({ tariffFlow }));\r\n  } catch ({ response }) {\r\n    yield Flash.error(response?.data?.messages[0] || 'Возникла ошибка');\r\n  }\r\n}\r\n\r\ntype ChangeTariff = {\r\n  id: number;\r\n  tariffId: number;\r\n};\r\n/** изменить тариф */\r\nfunction* changeTariffWorker({ payload }: { payload: ChangeTariff }) {\r\n  try {\r\n    const { id, tariffId } = payload;\r\n    const formData = new FormData();\r\n    formData.append('tariff', String(tariffId));\r\n    yield financeGateway.changeTariff(id, formData);\r\n    yield put(getFinanceInfo(id));\r\n    yield Flash.success('Настроки сохранены');\r\n  } catch ({ response }) {\r\n    yield Flash.error(response?.data?.messages[0] || 'Возникла ошибка');\r\n  }\r\n}\r\n\r\ntype GetTariffsByCompanyId = {\r\n  id: number;\r\n  params: number;\r\n};\r\n/** получить историю тарифов по id компании */\r\nfunction* getTariffsByCompanyIdWorker({ payload }: { payload: GetTariffsByCompanyId }) {\r\n  try {\r\n    const { id, params } = payload;\r\n    const response = yield financeGateway.getTariffsByCompanyId(id, params);\r\n    yield put(setTariffsByCompanyId({ tariffsHistory: response }));\r\n  } catch ({ response }) {\r\n    yield Flash.error(response?.data?.messages[0] || 'Возникла ошибка');\r\n  }\r\n}\r\n\r\ntype GgetTransactionsHistory = {\r\n  id: number;\r\n  offset?: number;\r\n  type?: string;\r\n  amount?: [{ from?: string }, { to?: string }];\r\n  createdAt?: [{ from?: string }, { to?: string }];\r\n  comment?: string;\r\n};\r\n/** получить историю транзакций */\r\nfunction* getTransactionsHistoryWorker({ payload }: { payload: GgetTransactionsHistory }) {\r\n  try {\r\n    const { id, ...params } = payload;\r\n    const response = yield financeGateway.getTransactionsHistory(id, params);\r\n    yield put(setTransactionsHistory({ transactionsHistory: response }));\r\n  } catch ({ response }) {\r\n    yield Flash.error(response?.data?.messages[0] || 'Возникла ошибка');\r\n  }\r\n}\r\n\r\n/** получить карточку тарифа */\r\nfunction* getTariffCardWorker({ payload }: { payload: number }) {\r\n  try {\r\n    yield put(getTariffFlow(payload));\r\n    const selectedTariff = yield financeGateway.getTariff(payload);\r\n    yield put(setTariff({ selectedTariff }));\r\n  } catch ({ response }) {\r\n    yield Flash.error('Возникла ошибка');\r\n  }\r\n}\r\n"]},"metadata":{},"sourceType":"module"}