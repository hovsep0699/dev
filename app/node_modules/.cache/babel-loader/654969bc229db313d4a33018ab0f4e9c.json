{"ast":null,"code":"import _objectSpread from\"C:\\\\Users\\\\Hovsep\\\\Desktop\\\\local\\\\diflow_react\\\\node_modules\\\\babel-preset-react-app\\\\node_modules\\\\@babel\\\\runtime/helpers/esm/objectSpread2\";import _classCallCheck from\"C:\\\\Users\\\\Hovsep\\\\Desktop\\\\local\\\\diflow_react\\\\node_modules\\\\babel-preset-react-app\\\\node_modules\\\\@babel\\\\runtime/helpers/esm/classCallCheck\";import _createClass from\"C:\\\\Users\\\\Hovsep\\\\Desktop\\\\local\\\\diflow_react\\\\node_modules\\\\babel-preset-react-app\\\\node_modules\\\\@babel\\\\runtime/helpers/esm/createClass\";import _get from\"C:\\\\Users\\\\Hovsep\\\\Desktop\\\\local\\\\diflow_react\\\\node_modules\\\\babel-preset-react-app\\\\node_modules\\\\@babel\\\\runtime/helpers/esm/get\";import _getPrototypeOf from\"C:\\\\Users\\\\Hovsep\\\\Desktop\\\\local\\\\diflow_react\\\\node_modules\\\\babel-preset-react-app\\\\node_modules\\\\@babel\\\\runtime/helpers/esm/getPrototypeOf\";import _inherits from\"C:\\\\Users\\\\Hovsep\\\\Desktop\\\\local\\\\diflow_react\\\\node_modules\\\\babel-preset-react-app\\\\node_modules\\\\@babel\\\\runtime/helpers/esm/inherits\";import _createSuper from\"C:\\\\Users\\\\Hovsep\\\\Desktop\\\\local\\\\diflow_react\\\\node_modules\\\\babel-preset-react-app\\\\node_modules\\\\@babel\\\\runtime/helpers/esm/createSuper\";import _applyDecoratedDescriptor from\"C:\\\\Users\\\\Hovsep\\\\Desktop\\\\local\\\\diflow_react\\\\node_modules\\\\babel-preset-react-app\\\\node_modules\\\\@babel\\\\runtime/helpers/esm/applyDecoratedDescriptor\";var _class;import React from'react';import autobind from'autobind-decorator';import{NavLink,Redirect}from'react-router-dom';import CertFormBase from'./CertFormBase';import{Form}from'informed';import AgreementModal from'../modals/AgreementModal';import{CertificateService}from'@distate/core/dist/application/certificate/CertificateService';import Core from'@distate/core/dist/application/Core';import UserAgreement from'@distate/core/dist/domain/register/UserAgreement';import Flash from'../../../common/flash/Flash';import classNames from'classnames';import{ddmmyyyy_hhmmss}from'../../../utils/DateUtil';import DiError from'@distate/core/dist/application/error/Error';import{AUTH_CERT,DOCUMENT,COMPANY}from'../../../common/Url';import{GO_TO_LOGIN_FORM,REG,SERVER_500}from'../../../common/Lbl';import MessageSuccessRegistration from'../messages/MessageSuccessRegistration';var RegisterByCertForm=(_class=/*#__PURE__*/function(_CertFormBase){_inherits(RegisterByCertForm,_CertFormBase);var _super=_createSuper(RegisterByCertForm);function RegisterByCertForm(props){var _this;_classCallCheck(this,RegisterByCertForm);_this=_super.call(this,props);_this.state=_objectSpread(_objectSpread({},_this.state),{},{agreement:null,redirectToReferrer:false,isFormSentSuccessfully:false});return _this;}_createClass(RegisterByCertForm,[{key:\"componentDidMount\",value:function componentDidMount(){this._isMounted=true;document.addEventListener('keydown',this.handleEnterKeyDown);this.updateCertificates();}},{key:\"handleEnterKeyDown\",value:function handleEnterKeyDown(e){if(e.key==='Enter'){this.submit();}}},{key:\"updateCertificates\",value:function updateCertificates(){var _this2=this;if(!this.state.isLoading){this.setState({isLoading:true});}CertificateService.getRegisterCertificates().then(this.handleCertsFromService).catch(function(error){_this2.handlePluginError(error);});}},{key:\"handleError\",value:function handleError(error){if(error instanceof DiError){this.setState({isLoading:false});if(error.jsError&&error.jsError.response){var status=error.jsError.response.status;switch(status){case 400:Flash.error(error);break;case 500:Flash.error(SERVER_500);break;default:throw new Error(\"\\u041D\\u0435 \\u043E\\u0431\\u0440\\u0430\\u0431\\u0430\\u0442\\u044B\\u0432\\u0430\\u0435\\u0442\\u0441\\u044F \\u0441\\u0442\\u0430\\u0442\\u0443\\u0441 \".concat(status));}}else{Flash.error(error);}}if(error.message){this.setState({errorMsg:error.message,isLoading:false});}}},{key:\"agreeCallback\",value:function agreeCallback(){var _this3=this;this.resetCertificates();var successAutoAuth=function successAutoAuth(isNaturalCreated){return function(loginResult){if(loginResult.success){return Core.init().then(function(){var redirectUrl=isNaturalCreated?DOCUMENT:COMPANY;_this3.setState({redirectToReferrer:true,redirectUrl:redirectUrl});});}};};var failAutoAuth=function failAutoAuth(error){Flash.error(error);};var isForceActivation=this.state.agreement.register_force_activation;return this.state.agreement.agree().then(function(res){if(isForceActivation){Core.auth({certificate:_this3.state.selectedCertificate}).then(successAutoAuth(res.isNaturalCreated)).catch(failAutoAuth);}else{_this3.setState({isFormSentSuccessfully:true});}}).catch(this.handleError);}},{key:\"disagreeCallback\",value:function disagreeCallback(){this.state.agreement.disagree().catch(function(error){console.log(error);});}},{key:\"submit\",value:function submit(){var _this4=this;var handleSuccess=function handleSuccess(registerResult){if(registerResult instanceof UserAgreement){_this4.setState({agreement:_objectSpread(_objectSpread({},registerResult.parameters),{},{agree:registerResult.agree,disagree:registerResult.disagree,certificate:_this4.state.selectedCertificate})});}};Core.register({certificate:this.state.selectedCertificate}).then(handleSuccess).catch(this.handleError);}},{key:\"setFormApi\",value:function setFormApi(formApi){this.formApi=formApi;}},{key:\"resolveEnterHandlersConflicts\",value:function resolveEnterHandlersConflicts(){if(this.state.agreement===null){document.addEventListener('keydown',this.handleEnterKeyDown);}else{document.removeEventListener('keydown',this.handleEnterKeyDown);}}},{key:\"componentDidUpdate\",value:function componentDidUpdate(prevProps,prevState){if(prevState===this.state){return;}this.resolveEnterHandlersConflicts();}},{key:\"componentWillUnmount\",value:function componentWillUnmount(){_get(_getPrototypeOf(RegisterByCertForm.prototype),\"componentWillUnmount\",this).call(this);document.removeEventListener('keydown',this.handleEnterKeyDown);}},{key:\"render\",value:function render(){var _this5=this;if(this.state.redirectToReferrer){return/*#__PURE__*/React.createElement(Redirect,{to:this.state.redirectUrl});}var overriddenSubmitBtnClasses=classNames({disabled:!this.state.certificates.length},this.submitBtnClasses);return this.state.isFormSentSuccessfully?/*#__PURE__*/React.createElement(React.Fragment,null,/*#__PURE__*/React.createElement(MessageSuccessRegistration,null),/*#__PURE__*/React.createElement(\"footer\",null,/*#__PURE__*/React.createElement(\"div\",{className:\"ds-button-block width-fluid-full\"},/*#__PURE__*/React.createElement(NavLink,{className:\"ds-button height-large width-fluid-full\",to:AUTH_CERT},GO_TO_LOGIN_FORM)))):/*#__PURE__*/React.createElement(React.Fragment,null,/*#__PURE__*/React.createElement(\"div\",{className:\"tabcontent active\",id:\"registerCertificate\"},/*#__PURE__*/React.createElement(Form,{id:\"login-certificate-form\",getApi:this.setFormApi,onSubmit:this.submit},this.renderCertificates(),/*#__PURE__*/React.createElement(\"input\",{name:\"signed_data\",type:\"hidden\",\"data-bind\":\"value: signedData\",value:\"\"}),/*#__PURE__*/React.createElement(\"footer\",null,/*#__PURE__*/React.createElement(\"div\",{className:\"ds-button-block width-fluid-full\"},/*#__PURE__*/React.createElement(\"input\",{className:overriddenSubmitBtnClasses,type:\"submit\",value:REG,tabIndex:2}),/*#__PURE__*/React.createElement(NavLink,{className:\"ds-button height-large width-fluid-full\",to:AUTH_CERT,tabIndex:3},GO_TO_LOGIN_FORM))))),this.state.agreement&&/*#__PURE__*/React.createElement(AgreementModal,{agree:this.agreeCallback,disagree:this.disagreeCallback,hide:function hide(){_this5.setState({agreement:null});},certSerialNumber:this.state.agreement.certificate.serialNumber,certThumbprint:this.state.agreement.certificate.thumbprint,certValidFromDate:ddmmyyyy_hhmmss(this.state.agreement.certificate.validFrom),certValidToDate:ddmmyyyy_hhmmss(this.state.agreement.certificate.validTo),checkboxTxt:this.state.agreement.register_checkbox,title:this.state.agreement.register_title,txt:this.state.agreement.register_text}));}}]);return RegisterByCertForm;}(CertFormBase),(_applyDecoratedDescriptor(_class.prototype,\"handleEnterKeyDown\",[autobind],Object.getOwnPropertyDescriptor(_class.prototype,\"handleEnterKeyDown\"),_class.prototype),_applyDecoratedDescriptor(_class.prototype,\"updateCertificates\",[autobind],Object.getOwnPropertyDescriptor(_class.prototype,\"updateCertificates\"),_class.prototype),_applyDecoratedDescriptor(_class.prototype,\"handleError\",[autobind],Object.getOwnPropertyDescriptor(_class.prototype,\"handleError\"),_class.prototype),_applyDecoratedDescriptor(_class.prototype,\"agreeCallback\",[autobind],Object.getOwnPropertyDescriptor(_class.prototype,\"agreeCallback\"),_class.prototype),_applyDecoratedDescriptor(_class.prototype,\"disagreeCallback\",[autobind],Object.getOwnPropertyDescriptor(_class.prototype,\"disagreeCallback\"),_class.prototype),_applyDecoratedDescriptor(_class.prototype,\"submit\",[autobind],Object.getOwnPropertyDescriptor(_class.prototype,\"submit\"),_class.prototype),_applyDecoratedDescriptor(_class.prototype,\"setFormApi\",[autobind],Object.getOwnPropertyDescriptor(_class.prototype,\"setFormApi\"),_class.prototype),_applyDecoratedDescriptor(_class.prototype,\"resolveEnterHandlersConflicts\",[autobind],Object.getOwnPropertyDescriptor(_class.prototype,\"resolveEnterHandlersConflicts\"),_class.prototype)),_class);export default RegisterByCertForm;","map":{"version":3,"sources":["C:/Users/Hovsep/Desktop/local/diflow_react/packages/app/src/pages/auth/forms/RegisterByCertForm.js"],"names":["React","autobind","NavLink","Redirect","CertFormBase","Form","AgreementModal","CertificateService","Core","UserAgreement","Flash","classNames","ddmmyyyy_hhmmss","DiError","AUTH_CERT","DOCUMENT","COMPANY","GO_TO_LOGIN_FORM","REG","SERVER_500","MessageSuccessRegistration","RegisterByCertForm","props","state","agreement","redirectToReferrer","isFormSentSuccessfully","_isMounted","document","addEventListener","handleEnterKeyDown","updateCertificates","e","key","submit","isLoading","setState","getRegisterCertificates","then","handleCertsFromService","catch","error","handlePluginError","jsError","response","status","Error","message","errorMsg","resetCertificates","successAutoAuth","isNaturalCreated","loginResult","success","init","redirectUrl","failAutoAuth","isForceActivation","register_force_activation","agree","res","auth","certificate","selectedCertificate","handleError","disagree","console","log","handleSuccess","registerResult","parameters","register","formApi","removeEventListener","prevProps","prevState","resolveEnterHandlersConflicts","overriddenSubmitBtnClasses","disabled","certificates","length","submitBtnClasses","setFormApi","renderCertificates","agreeCallback","disagreeCallback","serialNumber","thumbprint","validFrom","validTo","register_checkbox","register_title","register_text"],"mappings":"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","sourcesContent":["import React from 'react';\r\nimport autobind from 'autobind-decorator';\r\nimport { NavLink, Redirect } from 'react-router-dom';\r\nimport CertFormBase from './CertFormBase';\r\nimport { Form } from 'informed';\r\nimport AgreementModal from '../modals/AgreementModal';\r\n\r\nimport { CertificateService } from '@distate/core/dist/application/certificate/CertificateService';\r\nimport Core from '@distate/core/dist/application/Core';\r\nimport UserAgreement from '@distate/core/dist/domain/register/UserAgreement';\r\nimport Flash from '../../../common/flash/Flash';\r\nimport classNames from 'classnames';\r\nimport { ddmmyyyy_hhmmss } from '../../../utils/DateUtil';\r\nimport DiError from '@distate/core/dist/application/error/Error';\r\nimport { AUTH_CERT, DOCUMENT, COMPANY } from '../../../common/Url';\r\nimport { GO_TO_LOGIN_FORM, REG, SERVER_500 } from '../../../common/Lbl';\r\nimport MessageSuccessRegistration from '../messages/MessageSuccessRegistration';\r\n\r\nclass RegisterByCertForm extends CertFormBase {\r\n  constructor(props) {\r\n    super(props);\r\n    this.state = {\r\n      ...this.state,\r\n      agreement: null,\r\n      redirectToReferrer: false,\r\n      isFormSentSuccessfully: false\r\n    };\r\n  }\r\n  componentDidMount() {\r\n    this._isMounted = true;\r\n    document.addEventListener('keydown', this.handleEnterKeyDown);\r\n    this.updateCertificates();\r\n  }\r\n  @autobind\r\n  handleEnterKeyDown(e) {\r\n    if (e.key === 'Enter') {\r\n      this.submit();\r\n    }\r\n  }\r\n  @autobind\r\n  updateCertificates() {\r\n    if (!this.state.isLoading) {\r\n      this.setState({ isLoading: true });\r\n    }\r\n    CertificateService.getRegisterCertificates()\r\n      .then(this.handleCertsFromService)\r\n      .catch(error => {\r\n        this.handlePluginError(error);\r\n      });\r\n  }\r\n  @autobind\r\n  handleError(error) {\r\n    if (error instanceof DiError) {\r\n      this.setState({ isLoading: false });\r\n      if (error.jsError && error.jsError.response) {\r\n        const status = error.jsError.response.status;\r\n        switch (status) {\r\n          case 400:\r\n            Flash.error(error);\r\n            break;\r\n          case 500:\r\n            Flash.error(SERVER_500);\r\n            break;\r\n          default:\r\n            throw new Error(`Не обрабатывается статус ${status}`);\r\n        }\r\n      } else {\r\n        Flash.error(error);\r\n      }\r\n    }\r\n    if (error.message) {\r\n      this.setState({ errorMsg: error.message, isLoading: false });\r\n    }\r\n  }\r\n  @autobind\r\n  agreeCallback() {\r\n    this.resetCertificates();\r\n\r\n    const successAutoAuth = isNaturalCreated => loginResult => {\r\n      if (loginResult.success) {\r\n        return Core.init().then(() => {\r\n          const redirectUrl = isNaturalCreated ? DOCUMENT : COMPANY;\r\n          this.setState({ redirectToReferrer: true, redirectUrl });\r\n        });\r\n      }\r\n    };\r\n\r\n    const failAutoAuth = error => {\r\n      Flash.error(error);\r\n    };\r\n\r\n    const isForceActivation = this.state.agreement.register_force_activation;\r\n\r\n    return this.state.agreement\r\n      .agree()\r\n      .then(res => {\r\n        if (isForceActivation) {\r\n          Core.auth({ certificate: this.state.selectedCertificate })\r\n            .then(successAutoAuth(res.isNaturalCreated))\r\n            .catch(failAutoAuth);\r\n        } else {\r\n          this.setState({ isFormSentSuccessfully: true });\r\n        }\r\n      })\r\n      .catch(this.handleError);\r\n  }\r\n  @autobind\r\n  disagreeCallback() {\r\n    this.state.agreement.disagree().catch(error => {\r\n      console.log(error);\r\n    });\r\n  }\r\n  @autobind\r\n  submit() {\r\n    const handleSuccess = registerResult => {\r\n      if (registerResult instanceof UserAgreement) {\r\n        this.setState({\r\n          agreement: {\r\n            ...registerResult.parameters,\r\n            agree: registerResult.agree,\r\n            disagree: registerResult.disagree,\r\n            certificate: this.state.selectedCertificate\r\n          }\r\n        });\r\n      }\r\n    };\r\n    Core.register({ certificate: this.state.selectedCertificate })\r\n      .then(handleSuccess)\r\n      .catch(this.handleError);\r\n  }\r\n  @autobind\r\n  setFormApi(formApi) {\r\n    this.formApi = formApi;\r\n  }\r\n  @autobind\r\n  resolveEnterHandlersConflicts() {\r\n    if (this.state.agreement === null) {\r\n      document.addEventListener('keydown', this.handleEnterKeyDown);\r\n    } else {\r\n      document.removeEventListener('keydown', this.handleEnterKeyDown);\r\n    }\r\n  }\r\n  componentDidUpdate(prevProps, prevState) {\r\n    if (prevState === this.state) {\r\n      return;\r\n    }\r\n    this.resolveEnterHandlersConflicts();\r\n  }\r\n  componentWillUnmount() {\r\n    super.componentWillUnmount();\r\n    document.removeEventListener('keydown', this.handleEnterKeyDown);\r\n  }\r\n  render() {\r\n    if (this.state.redirectToReferrer) {\r\n      return <Redirect to={this.state.redirectUrl} />;\r\n    }\r\n\r\n    const overriddenSubmitBtnClasses = classNames(\r\n      { disabled: !this.state.certificates.length },\r\n      this.submitBtnClasses\r\n    );\r\n\r\n    return this.state.isFormSentSuccessfully ? (\r\n      <React.Fragment>\r\n        <MessageSuccessRegistration />\r\n        <footer>\r\n          <div className=\"ds-button-block width-fluid-full\">\r\n            <NavLink className=\"ds-button height-large width-fluid-full\" to={AUTH_CERT}>\r\n              {GO_TO_LOGIN_FORM}\r\n            </NavLink>\r\n          </div>\r\n        </footer>\r\n      </React.Fragment>\r\n    ) : (\r\n      <React.Fragment>\r\n        <div className=\"tabcontent active\" id=\"registerCertificate\">\r\n          <Form id=\"login-certificate-form\" getApi={this.setFormApi} onSubmit={this.submit}>\r\n            {this.renderCertificates()}\r\n\r\n            <input name=\"signed_data\" type=\"hidden\" data-bind=\"value: signedData\" value=\"\" />\r\n            <footer>\r\n              <div className=\"ds-button-block width-fluid-full\">\r\n                <input\r\n                  className={overriddenSubmitBtnClasses}\r\n                  type=\"submit\"\r\n                  value={REG}\r\n                  tabIndex={2}\r\n                />\r\n                <NavLink\r\n                  className=\"ds-button height-large width-fluid-full\"\r\n                  to={AUTH_CERT}\r\n                  tabIndex={3}\r\n                >\r\n                  {GO_TO_LOGIN_FORM}\r\n                </NavLink>\r\n              </div>\r\n            </footer>\r\n          </Form>\r\n        </div>\r\n        {this.state.agreement && (\r\n          <AgreementModal\r\n            agree={this.agreeCallback}\r\n            disagree={this.disagreeCallback}\r\n            hide={() => {\r\n              this.setState({ agreement: null });\r\n            }}\r\n            certSerialNumber={this.state.agreement.certificate.serialNumber}\r\n            certThumbprint={this.state.agreement.certificate.thumbprint}\r\n            certValidFromDate={ddmmyyyy_hhmmss(this.state.agreement.certificate.validFrom)}\r\n            certValidToDate={ddmmyyyy_hhmmss(this.state.agreement.certificate.validTo)}\r\n            checkboxTxt={this.state.agreement.register_checkbox}\r\n            title={this.state.agreement.register_title}\r\n            txt={this.state.agreement.register_text}\r\n          />\r\n        )}\r\n      </React.Fragment>\r\n    );\r\n  }\r\n}\r\n\r\nexport default RegisterByCertForm;\r\n"]},"metadata":{},"sourceType":"module"}