{"ast":null,"code":"import _classCallCheck from\"C:\\\\Users\\\\Hovsep\\\\Desktop\\\\local\\\\diflow_react\\\\node_modules\\\\babel-preset-react-app\\\\node_modules\\\\@babel\\\\runtime/helpers/esm/classCallCheck\";import _createClass from\"C:\\\\Users\\\\Hovsep\\\\Desktop\\\\local\\\\diflow_react\\\\node_modules\\\\babel-preset-react-app\\\\node_modules\\\\@babel\\\\runtime/helpers/esm/createClass\";import _inherits from\"C:\\\\Users\\\\Hovsep\\\\Desktop\\\\local\\\\diflow_react\\\\node_modules\\\\babel-preset-react-app\\\\node_modules\\\\@babel\\\\runtime/helpers/esm/inherits\";import _createSuper from\"C:\\\\Users\\\\Hovsep\\\\Desktop\\\\local\\\\diflow_react\\\\node_modules\\\\babel-preset-react-app\\\\node_modules\\\\@babel\\\\runtime/helpers/esm/createSuper\";import _applyDecoratedDescriptor from\"C:\\\\Users\\\\Hovsep\\\\Desktop\\\\local\\\\diflow_react\\\\node_modules\\\\babel-preset-react-app\\\\node_modules\\\\@babel\\\\runtime/helpers/esm/applyDecoratedDescriptor\";var _class;import React,{Component}from'react';import Dropdown from'../dropdown/Dropdown';import{BOTTOM_RIGHT}from'../Placement';import Badge from'../Badge';import Button,{SECONDARY}from'../Button';import{ICON}from'@distate/components';import{NO_NEW_NOTIFICATIONS,NO_NOTIFICATIONS,NOTIFICATIONS,SHOW_MORE}from'../Lbl';import DropdownHeader from'../dropdown/DropdownHeader';import TabMenu from'../tabs/TabMenu';import Tab from'../tabs/Tab';import TabContent from'../tabs/TabContent';import NotificationService from'@distate/core/dist/application/notifications/NotificationService';import Flash from'../../common/flash/Flash';import autobind from'autobind-decorator';import{Loading}from'@distate/components';import DocumentNotification from'../notifications/DocumentNotification';import ContractNotification from'../notifications/ContractNotification';import Environment from'@distate/core/dist/application/Environment';import NotificationGateway from'@distate/core/dist/application/notifications/NotificationGateway';import NotificationContractGateway from'@distate/core/dist/application/notifications/NotificationContractGateway';var NEW='Новые';var READ='Прочитанные';var INTERVAL_MS=5000;var LIMIT_INCREMENT=5;var NotificationsMenu=(_class=/*#__PURE__*/function(_Component){_inherits(NotificationsMenu,_Component);var _super=_createSuper(NotificationsMenu);function NotificationsMenu(props){var _this;_classCallCheck(this,NotificationsMenu);_this=_super.call(this,props);_this._isMounted=false;_this.state={newCount:0,readCount:0,newLimit:LIMIT_INCREMENT,readLimit:LIMIT_INCREMENT,new:[],read:[],intervalId:null,currentTab:NEW,isBusy:false};return _this;}_createClass(NotificationsMenu,[{key:\"componentDidMount\",value:function componentDidMount(){this._isMounted=true;this.startGettingNewNotifications();this.getReadNotifications();}},{key:\"componentDidUpdate\",value:function componentDidUpdate(prevProps,prevState){var _this2=this;if(prevState.newLimit!==this.state.newLimit){this.setState({isBusy:true});this.startGettingNewNotifications().then(function(){_this2.setState({isBusy:false});});}if(prevState.readLimit!==this.state.readLimit){this.setState({isBusy:true});this.getReadNotifications().then(function(){_this2.setState({isBusy:false});});}}},{key:\"componentWillUnmount\",value:function componentWillUnmount(){this._isMounted=false;if(this.state.intervalId){clearInterval(this.state.intervalId);}}},{key:\"startGettingNewNotifications\",value:function startGettingNewNotifications(){var _this3=this;var interval=this.state.intervalId;var task=this.getNewNotifications;if(interval){clearInterval(interval);}return task().then(function(){if(_this3._isMounted){_this3.setState({intervalId:setInterval(task,INTERVAL_MS)});}});}},{key:\"getNewNotifications\",value:function getNewNotifications(){var _this4=this;var limit=this.state.newLimit;return NotificationService.getNew(limit).then(function(res){if(_this4._isMounted){_this4.setState({newCount:res.recordsTotal,new:res.rows});}}).catch(function(error){Flash.error(error);});}},{key:\"getReadNotifications\",value:function getReadNotifications(){var _this5=this;var limit=this.state.readLimit;return NotificationService.getRead(limit).then(function(res){if(_this5._isMounted){_this5.setState({readCount:res.recordsTotal,read:res.rows});}}).catch(function(error){Flash.error(error);});}},{key:\"incrementNewLimit\",value:function incrementNewLimit(){var incremented=this.state.newLimit+LIMIT_INCREMENT;this.setState({newLimit:incremented});}},{key:\"incrementReadLimit\",value:function incrementReadLimit(){var incremented=this.state.readLimit+LIMIT_INCREMENT;this.setState({readLimit:incremented});}},{key:\"getDocumentTypeTitle\",value:function getDocumentTypeTitle(flowGroupTitle){switch(flowGroupTitle){case'акт':return'Акт';case'универсальный передаточный документ':return'УПД';case'универсальный корректировочный документ':return'УКД';case'Неформализованный документооборот':return'Неформализованный документ';case'счет на оплату':return'Счет на оплату';case'накладная':return'Накладная';case'счет-фактура':return'Счет-фактура';case'корректировочный счет-фактура':return'Корректировочный счет-фактура';case'информационное сообщение':return'Инфосооб';default:return'Документ';}}},{key:\"createDocumentNotification\",value:function createDocumentNotification(notification,type){var notification_id=notification.notification_id,document_id=notification.document_id,document_number=notification.document_number,type_title=notification.type_title,flow_type_group_title=notification.flow_type_group_title,type_system_name=notification.type_system_name,created_at=notification.created_at;var isNew=type===NEW;return/*#__PURE__*/React.createElement(DocumentNotification,{key:notification_id,notificationId:notification_id,notificationStatus:type_system_name,docId:document_id,docNumber:document_number,docStatus:type_title,docTypeTitle:this.getDocumentTypeTitle(flow_type_group_title),createdAt:created_at,isNew:isNew});}},{key:\"createContractNotification\",value:function createContractNotification(notification,type){var notification_id=notification.notification_id,contract_id=notification.contract_id,contract_number=notification.contract_number,type_title=notification.type_title,contract_title=notification.contract_title,type_system_name=notification.type_system_name,created_at=notification.created_at;var isNew=type===NEW;return/*#__PURE__*/React.createElement(ContractNotification,{key:notification_id,notificationId:notification_id,notificationStatus:type_system_name,contractId:contract_id,contractNumber:contract_number,contractStatus:type_title,contractTypeTitle:this.getDocumentTypeTitle(contract_title),createdAt:created_at,isNew:isNew});}},{key:\"renderNotifications\",value:function renderNotifications(type){var _this6=this;var notifications=[];if(type===READ){notifications=this.state.read;}else{notifications=this.state.new;}return/*#__PURE__*/React.createElement(\"ul\",null,notifications.map(function(item){if(item.hasOwnProperty('contract_id')&&process.env.REACT_APP_FEATURE==='contracts'){return _this6.createContractNotification(item,type);}else{return _this6.createDocumentNotification(item,type);}}));}},{key:\"renderEmpty\",value:function renderEmpty(text){return/*#__PURE__*/React.createElement(\"div\",{className:\"text-center notification-empty\"},/*#__PURE__*/React.createElement(\"i\",{className:\"ico ico-bell large color-grey\"}),/*#__PURE__*/React.createElement(\"p\",{className:\"text\"},text));}},{key:\"makeSelectIdsRead\",value:function makeSelectIdsRead(ids){var _this7=this;this.setState({isBusy:true});if(ids.length>0){NotificationService.read(ids).then(this.startGettingNewNotifications).then(this.getReadNotifications).then(function(){_this7.setState({isBusy:false});}).catch(function(error){Flash.error(error);_this7.setState({isBusy:false});});}}},{key:\"makeAllRead\",value:function makeAllRead(){if(process.env.REACT_APP_FEATURE==='contracts'){Environment.setNotificationsGateway(new NotificationGateway());}var documentIdsToMakeRead=this.state.new.filter(function(notification){return!!notification.document_id;}).map(function(notification){return notification.notification_id;});this.makeSelectIdsRead(documentIdsToMakeRead);if(process.env.REACT_APP_FEATURE==='contracts'){Environment.setNotificationsGateway(new NotificationContractGateway());var contractIdsToMakeRead=this.state.new.filter(function(notification){return!!notification.contract_id;}).map(function(notification){return notification.notification_id;});this.makeSelectIdsRead(contractIdsToMakeRead);}}},{key:\"changeTab\",value:function changeTab(label){this.setState({currentTab:label});}},{key:\"renderShowMoreBtn\",value:function renderShowMoreBtn(callback){return/*#__PURE__*/React.createElement(Button,{type:\"button\",colorClass:SECONDARY,className:\"width-fluid-full\",onClick:callback},SHOW_MORE);}},{key:\"render\",value:function render(){var isNewActive=this.state.currentTab===NEW;var isReadActive=this.state.currentTab===READ;var showNewBtn=this.state.newLimit<this.state.newCount;var showReadBtn=this.state.readLimit<this.state.readCount;return/*#__PURE__*/React.createElement(Dropdown,{widthRestrict:true,placement:BOTTOM_RIGHT,trigger:/*#__PURE__*/React.createElement(Badge,{digit:this.state.newCount},/*#__PURE__*/React.createElement(Button,{iconClass:ICON.bell},NOTIFICATIONS))},/*#__PURE__*/React.createElement(React.Fragment,null,this.state.isBusy&&/*#__PURE__*/React.createElement(Loading,{isRelative:false})),/*#__PURE__*/React.createElement(DropdownHeader,null,/*#__PURE__*/React.createElement(\"span\",null,NOTIFICATIONS),/*#__PURE__*/React.createElement(\"span\",{className:\"right\"},this.state.newCount,\"\\xA0\\u043D\\u043E\\u0432\\u044B\\u0445\"),/*#__PURE__*/React.createElement(TabMenu,null,/*#__PURE__*/React.createElement(Tab,{label:NEW,isActive:isNewActive,onClick:this.changeTab}),/*#__PURE__*/React.createElement(Tab,{label:READ,isActive:isReadActive,onClick:this.changeTab}))),/*#__PURE__*/React.createElement(TabContent,{isActive:isNewActive},/*#__PURE__*/React.createElement(\"div\",{className:\"dropdown-scroll\"},this.state.new.length===0?this.renderEmpty(NO_NEW_NOTIFICATIONS):this.renderNotifications(NEW)),this.state.new.length!==0&&/*#__PURE__*/React.createElement(\"div\",{className:\"col-12 slim\"},/*#__PURE__*/React.createElement(\"div\",{className:\"col-6 slim\"},showNewBtn&&this.renderShowMoreBtn(this.incrementNewLimit)),/*#__PURE__*/React.createElement(\"div\",{className:\"col-6 slim\"},/*#__PURE__*/React.createElement(Button,{type:\"button\",className:\"width-fluid-full\",onClick:this.makeAllRead},\"\\u0412 \\u043F\\u0440\\u043E\\u0447\\u0438\\u0442\\u0430\\u043D\\u043D\\u044B\\u0435\")))),/*#__PURE__*/React.createElement(TabContent,{isActive:isReadActive},/*#__PURE__*/React.createElement(\"div\",{className:\"dropdown-scroll\"},this.state.read.length===0?this.renderEmpty(NO_NOTIFICATIONS):this.renderNotifications(READ)),/*#__PURE__*/React.createElement(\"div\",{className:\"col-12 slim\"},showReadBtn&&this.renderShowMoreBtn(this.incrementReadLimit))));}}]);return NotificationsMenu;}(Component),(_applyDecoratedDescriptor(_class.prototype,\"startGettingNewNotifications\",[autobind],Object.getOwnPropertyDescriptor(_class.prototype,\"startGettingNewNotifications\"),_class.prototype),_applyDecoratedDescriptor(_class.prototype,\"getNewNotifications\",[autobind],Object.getOwnPropertyDescriptor(_class.prototype,\"getNewNotifications\"),_class.prototype),_applyDecoratedDescriptor(_class.prototype,\"getReadNotifications\",[autobind],Object.getOwnPropertyDescriptor(_class.prototype,\"getReadNotifications\"),_class.prototype),_applyDecoratedDescriptor(_class.prototype,\"incrementNewLimit\",[autobind],Object.getOwnPropertyDescriptor(_class.prototype,\"incrementNewLimit\"),_class.prototype),_applyDecoratedDescriptor(_class.prototype,\"incrementReadLimit\",[autobind],Object.getOwnPropertyDescriptor(_class.prototype,\"incrementReadLimit\"),_class.prototype),_applyDecoratedDescriptor(_class.prototype,\"createDocumentNotification\",[autobind],Object.getOwnPropertyDescriptor(_class.prototype,\"createDocumentNotification\"),_class.prototype),_applyDecoratedDescriptor(_class.prototype,\"createContractNotification\",[autobind],Object.getOwnPropertyDescriptor(_class.prototype,\"createContractNotification\"),_class.prototype),_applyDecoratedDescriptor(_class.prototype,\"makeSelectIdsRead\",[autobind],Object.getOwnPropertyDescriptor(_class.prototype,\"makeSelectIdsRead\"),_class.prototype),_applyDecoratedDescriptor(_class.prototype,\"makeAllRead\",[autobind],Object.getOwnPropertyDescriptor(_class.prototype,\"makeAllRead\"),_class.prototype),_applyDecoratedDescriptor(_class.prototype,\"changeTab\",[autobind],Object.getOwnPropertyDescriptor(_class.prototype,\"changeTab\"),_class.prototype)),_class);export default NotificationsMenu;","map":{"version":3,"sources":["C:/Users/Hovsep/Desktop/local/diflow_react/packages/app/src/common/topbar/NotificationsMenu.js"],"names":["React","Component","Dropdown","BOTTOM_RIGHT","Badge","Button","SECONDARY","ICON","NO_NEW_NOTIFICATIONS","NO_NOTIFICATIONS","NOTIFICATIONS","SHOW_MORE","DropdownHeader","TabMenu","Tab","TabContent","NotificationService","Flash","autobind","Loading","DocumentNotification","ContractNotification","Environment","NotificationGateway","NotificationContractGateway","NEW","READ","INTERVAL_MS","LIMIT_INCREMENT","NotificationsMenu","props","_isMounted","state","newCount","readCount","newLimit","readLimit","new","read","intervalId","currentTab","isBusy","startGettingNewNotifications","getReadNotifications","prevProps","prevState","setState","then","clearInterval","interval","task","getNewNotifications","setInterval","limit","getNew","res","recordsTotal","rows","catch","error","getRead","incremented","flowGroupTitle","notification","type","notification_id","document_id","document_number","type_title","flow_type_group_title","type_system_name","created_at","isNew","getDocumentTypeTitle","contract_id","contract_number","contract_title","notifications","map","item","hasOwnProperty","process","env","REACT_APP_FEATURE","createContractNotification","createDocumentNotification","text","ids","length","setNotificationsGateway","documentIdsToMakeRead","filter","makeSelectIdsRead","contractIdsToMakeRead","label","callback","isNewActive","isReadActive","showNewBtn","showReadBtn","bell","changeTab","renderEmpty","renderNotifications","renderShowMoreBtn","incrementNewLimit","makeAllRead","incrementReadLimit"],"mappings":"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","sourcesContent":["import React, { Component } from 'react';\r\nimport Dropdown from '../dropdown/Dropdown';\r\nimport { BOTTOM_RIGHT } from '../Placement';\r\nimport Badge from '../Badge';\r\nimport Button, { SECONDARY } from '../Button';\r\nimport { ICON } from '@distate/components';\r\nimport { NO_NEW_NOTIFICATIONS, NO_NOTIFICATIONS, NOTIFICATIONS, SHOW_MORE } from '../Lbl';\r\nimport DropdownHeader from '../dropdown/DropdownHeader';\r\nimport TabMenu from '../tabs/TabMenu';\r\nimport Tab from '../tabs/Tab';\r\nimport TabContent from '../tabs/TabContent';\r\nimport NotificationService from '@distate/core/dist/application/notifications/NotificationService';\r\nimport Flash from '../../common/flash/Flash';\r\nimport autobind from 'autobind-decorator';\r\nimport { Loading } from '@distate/components';\r\nimport DocumentNotification from '../notifications/DocumentNotification';\r\nimport ContractNotification from '../notifications/ContractNotification';\r\nimport Environment from '@distate/core/dist/application/Environment';\r\nimport NotificationGateway from '@distate/core/dist/application/notifications/NotificationGateway';\r\nimport NotificationContractGateway from '@distate/core/dist/application/notifications/NotificationContractGateway';\r\n\r\nconst NEW = 'Новые';\r\nconst READ = 'Прочитанные';\r\nconst INTERVAL_MS = 5000;\r\nconst LIMIT_INCREMENT = 5;\r\n\r\nclass NotificationsMenu extends Component {\r\n  constructor(props) {\r\n    super(props);\r\n\r\n    this._isMounted = false;\r\n    this.state = {\r\n      newCount: 0,\r\n      readCount: 0,\r\n      newLimit: LIMIT_INCREMENT,\r\n      readLimit: LIMIT_INCREMENT,\r\n      new: [],\r\n      read: [],\r\n      intervalId: null,\r\n      currentTab: NEW,\r\n      isBusy: false\r\n    };\r\n  }\r\n\r\n  componentDidMount() {\r\n    this._isMounted = true;\r\n    this.startGettingNewNotifications();\r\n    this.getReadNotifications();\r\n  }\r\n\r\n  componentDidUpdate(prevProps, prevState) {\r\n    if (prevState.newLimit !== this.state.newLimit) {\r\n      this.setState({ isBusy: true });\r\n      this.startGettingNewNotifications().then(() => {\r\n        this.setState({ isBusy: false });\r\n      });\r\n    }\r\n    if (prevState.readLimit !== this.state.readLimit) {\r\n      this.setState({ isBusy: true });\r\n      this.getReadNotifications().then(() => {\r\n        this.setState({ isBusy: false });\r\n      });\r\n    }\r\n  }\r\n\r\n  componentWillUnmount() {\r\n    this._isMounted = false;\r\n    if (this.state.intervalId) {\r\n      clearInterval(this.state.intervalId);\r\n    }\r\n  }\r\n\r\n  @autobind\r\n  startGettingNewNotifications() {\r\n    let interval = this.state.intervalId;\r\n    const task = this.getNewNotifications;\r\n    if (interval) {\r\n      clearInterval(interval);\r\n    }\r\n    return task().then(() => {\r\n      if(this._isMounted) {\r\n        this.setState({ intervalId: setInterval(task, INTERVAL_MS) });\r\n      }\r\n    });\r\n  }\r\n\r\n  @autobind\r\n  getNewNotifications() {\r\n    const limit = this.state.newLimit;\r\n    return NotificationService.getNew(limit)\r\n      .then(res => {\r\n        if(this._isMounted) {\r\n          this.setState({ newCount: res.recordsTotal, new: res.rows });\r\n        }\r\n      })\r\n      .catch(error => {\r\n        Flash.error(error);\r\n      });\r\n  }\r\n\r\n  @autobind\r\n  getReadNotifications() {\r\n    const limit = this.state.readLimit;\r\n    return NotificationService.getRead(limit)\r\n      .then(res => {\r\n        if(this._isMounted) {\r\n          this.setState({ readCount: res.recordsTotal, read: res.rows });\r\n        }\r\n      })\r\n      .catch(error => {\r\n        Flash.error(error);\r\n      });\r\n  }\r\n\r\n  @autobind\r\n  incrementNewLimit() {\r\n    const incremented = this.state.newLimit + LIMIT_INCREMENT;\r\n    this.setState({\r\n      newLimit: incremented\r\n    });\r\n  }\r\n\r\n  @autobind\r\n  incrementReadLimit() {\r\n    const incremented = this.state.readLimit + LIMIT_INCREMENT;\r\n    this.setState({\r\n      readLimit: incremented\r\n    });\r\n  }\r\n\r\n  getDocumentTypeTitle(flowGroupTitle) {\r\n    switch (flowGroupTitle) {\r\n      case 'акт':\r\n        return 'Акт';\r\n      case 'универсальный передаточный документ':\r\n        return 'УПД';\r\n      case 'универсальный корректировочный документ':\r\n        return 'УКД';\r\n      case 'Неформализованный документооборот':\r\n        return 'Неформализованный документ';\r\n      case 'счет на оплату':\r\n        return 'Счет на оплату';\r\n      case 'накладная':\r\n        return 'Накладная';\r\n      case 'счет-фактура':\r\n        return 'Счет-фактура';\r\n      case 'корректировочный счет-фактура':\r\n        return 'Корректировочный счет-фактура';\r\n      case 'информационное сообщение':\r\n        return 'Инфосооб';\r\n      default:\r\n        return 'Документ';\r\n    }\r\n  }\r\n\r\n  @autobind\r\n  createDocumentNotification(notification, type) {\r\n    const {\r\n      notification_id,\r\n      document_id,\r\n      document_number,\r\n      type_title,\r\n      flow_type_group_title,\r\n      type_system_name,\r\n      created_at\r\n    } = notification;\r\n    const isNew = type === NEW;\r\n\r\n    return (\r\n      <DocumentNotification\r\n        key={notification_id}\r\n        notificationId={notification_id}\r\n        notificationStatus={type_system_name}\r\n        docId={document_id}\r\n        docNumber={document_number}\r\n        docStatus={type_title}\r\n        docTypeTitle={this.getDocumentTypeTitle(flow_type_group_title)}\r\n        createdAt={created_at}\r\n        isNew={isNew}\r\n      />\r\n    );\r\n  }\r\n\r\n  @autobind\r\n  createContractNotification(notification, type) {\r\n    const {\r\n      notification_id,\r\n      contract_id,\r\n      contract_number,\r\n      type_title,\r\n      contract_title,\r\n      type_system_name,\r\n      created_at\r\n    } = notification;\r\n    const isNew = type === NEW;\r\n\r\n    return (\r\n      <ContractNotification\r\n        key={notification_id}\r\n        notificationId={notification_id}\r\n        notificationStatus={type_system_name}\r\n        contractId={contract_id}\r\n        contractNumber={contract_number}\r\n        contractStatus={type_title}\r\n        contractTypeTitle={this.getDocumentTypeTitle(contract_title)}\r\n        createdAt={created_at}\r\n        isNew={isNew}\r\n      />\r\n    );\r\n  }\r\n\r\n  renderNotifications(type) {\r\n    let notifications = [];\r\n    if (type === READ) {\r\n      notifications = this.state.read;\r\n    } else {\r\n      notifications = this.state.new;\r\n    }\r\n    return (\r\n      <ul>\r\n        {notifications.map(item => {\r\n          if (item.hasOwnProperty('contract_id') && process.env.REACT_APP_FEATURE === 'contracts') {\r\n            return this.createContractNotification(item, type);\r\n          } else {\r\n            return this.createDocumentNotification(item, type);\r\n          }\r\n        })}\r\n      </ul>\r\n    );\r\n  }\r\n\r\n  renderEmpty(text) {\r\n    return (\r\n      <div className=\"text-center notification-empty\">\r\n        <i className=\"ico ico-bell large color-grey\"></i>\r\n        <p className=\"text\">{text}</p>\r\n      </div>\r\n    );\r\n  }\r\n\r\n  @autobind\r\n  makeSelectIdsRead(ids) {\r\n    this.setState({ isBusy: true });\r\n    if (ids.length > 0) {\r\n      NotificationService.read(ids)\r\n        .then(this.startGettingNewNotifications)\r\n        .then(this.getReadNotifications)\r\n        .then(() => {\r\n          this.setState({ isBusy: false });\r\n        })\r\n        .catch(error => {\r\n          Flash.error(error);\r\n          this.setState({ isBusy: false });\r\n        });\r\n    }\r\n  }\r\n\r\n  @autobind\r\n  makeAllRead() {\r\n    if (process.env.REACT_APP_FEATURE === 'contracts') {\r\n      Environment.setNotificationsGateway(new NotificationGateway());\r\n    }\r\n\r\n    const documentIdsToMakeRead = this.state.new\r\n      .filter(notification => !!notification.document_id)\r\n      .map(notification => notification.notification_id);\r\n    this.makeSelectIdsRead(documentIdsToMakeRead);\r\n\r\n    if (process.env.REACT_APP_FEATURE === 'contracts') {\r\n      Environment.setNotificationsGateway(new NotificationContractGateway());\r\n      const contractIdsToMakeRead = this.state.new\r\n        .filter(notification => !!notification.contract_id)\r\n        .map(notification => notification.notification_id);\r\n      this.makeSelectIdsRead(contractIdsToMakeRead);\r\n    }\r\n  }\r\n\r\n  @autobind\r\n  changeTab(label) {\r\n    this.setState({ currentTab: label });\r\n  }\r\n  renderShowMoreBtn(callback) {\r\n    return (\r\n      <Button type=\"button\" colorClass={SECONDARY} className=\"width-fluid-full\" onClick={callback}>\r\n        {SHOW_MORE}\r\n      </Button>\r\n    );\r\n  }\r\n\r\n  render() {\r\n    const isNewActive = this.state.currentTab === NEW;\r\n    const isReadActive = this.state.currentTab === READ;\r\n    const showNewBtn = this.state.newLimit < this.state.newCount;\r\n    const showReadBtn = this.state.readLimit < this.state.readCount;\r\n    return (\r\n      <Dropdown\r\n        widthRestrict\r\n        placement={BOTTOM_RIGHT}\r\n        trigger={\r\n          <Badge digit={this.state.newCount}>\r\n            <Button iconClass={ICON.bell}>{NOTIFICATIONS}</Button>\r\n          </Badge>\r\n        }\r\n      >\r\n        <React.Fragment>{this.state.isBusy && <Loading isRelative={false} />}</React.Fragment>\r\n        <DropdownHeader>\r\n          <span>{NOTIFICATIONS}</span>\r\n          <span className=\"right\">{this.state.newCount}&nbsp;новых</span>\r\n          <TabMenu>\r\n            <Tab label={NEW} isActive={isNewActive} onClick={this.changeTab}></Tab>\r\n            <Tab label={READ} isActive={isReadActive} onClick={this.changeTab}></Tab>\r\n          </TabMenu>\r\n        </DropdownHeader>\r\n        <TabContent isActive={isNewActive}>\r\n          <div className=\"dropdown-scroll\">\r\n            {this.state.new.length === 0\r\n              ? this.renderEmpty(NO_NEW_NOTIFICATIONS)\r\n              : this.renderNotifications(NEW)}\r\n          </div>\r\n          {this.state.new.length !== 0 && (\r\n            <div className=\"col-12 slim\">\r\n              <div className=\"col-6 slim\">\r\n                {showNewBtn && this.renderShowMoreBtn(this.incrementNewLimit)}\r\n              </div>\r\n              <div className=\"col-6 slim\">\r\n                <Button type=\"button\" className=\"width-fluid-full\" onClick={this.makeAllRead}>\r\n                  В прочитанные\r\n                </Button>\r\n              </div>\r\n            </div>\r\n          )}\r\n        </TabContent>\r\n        <TabContent isActive={isReadActive}>\r\n          <div className=\"dropdown-scroll\">\r\n            {this.state.read.length === 0\r\n              ? this.renderEmpty(NO_NOTIFICATIONS)\r\n              : this.renderNotifications(READ)}\r\n          </div>\r\n          <div className=\"col-12 slim\">\r\n            {showReadBtn && this.renderShowMoreBtn(this.incrementReadLimit)}\r\n          </div>\r\n        </TabContent>\r\n      </Dropdown>\r\n    );\r\n  }\r\n}\r\n\r\nexport default NotificationsMenu;\r\n"]},"metadata":{},"sourceType":"module"}