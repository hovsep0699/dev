{"ast":null,"code":"import _regeneratorRuntime from\"C:\\\\Users\\\\Hovsep\\\\Desktop\\\\local\\\\diflow_react\\\\node_modules\\\\babel-preset-react-app\\\\node_modules\\\\@babel\\\\runtime/regenerator\";import _asyncToGenerator from\"C:\\\\Users\\\\Hovsep\\\\Desktop\\\\local\\\\diflow_react\\\\node_modules\\\\babel-preset-react-app\\\\node_modules\\\\@babel\\\\runtime/helpers/esm/asyncToGenerator\";import _objectSpread from\"C:\\\\Users\\\\Hovsep\\\\Desktop\\\\local\\\\diflow_react\\\\node_modules\\\\babel-preset-react-app\\\\node_modules\\\\@babel\\\\runtime/helpers/esm/objectSpread2\";import _classCallCheck from\"C:\\\\Users\\\\Hovsep\\\\Desktop\\\\local\\\\diflow_react\\\\node_modules\\\\babel-preset-react-app\\\\node_modules\\\\@babel\\\\runtime/helpers/esm/classCallCheck\";import _createClass from\"C:\\\\Users\\\\Hovsep\\\\Desktop\\\\local\\\\diflow_react\\\\node_modules\\\\babel-preset-react-app\\\\node_modules\\\\@babel\\\\runtime/helpers/esm/createClass\";import axios from'axios';import DocumentsService from'@distate/core/dist/application/documents/common/DocumentsService';import fileDownload from'js-file-download';import statusData from'../helpers/documents.status';import{parseValue}from'../helpers/documnets.helpers';var packageStatusData=statusData;var DocumentsApi=/*#__PURE__*/function(){function DocumentsApi(){var _this=this;_classCallCheck(this,DocumentsApi);this.config={method:'get'};this.defaulFiltered={inbox:{isArchival:0,packageTypes:['IN']},outbox:{isArchival:0,packageTypes:['OUT'],documentStatuses:['sent']},archive:{isArchival:1},draft:{isArchival:0,packageTypes:['OUT'],documentStatuses:['draft','signed']}};this.documentFlows={ACT_423:['act_423','roaming_act_423'],ACT:['act','act_552','roaming_act_552','taxcomhub_act_552'],BILATERAL:['bilateral','roaming_unformalized_bilateral','connector_unformalized_bilateral'],UNILATERAL:['unilateral','roaming_unformalized_unilateral','connector_unformalized_unilateral'],WAYBILL:['waybill','waybill_551','roaming_waybill_551','taxcomhub_waybill_551'],INVOICE:['invoice','invoice_utd_174','invoice_utd_14'],INVOICE_CORRECTION:['invoice_correction','invoice_correction_ucd_174','invoice_correction_ucd_14'],UTD:['utd_174_invoice','utd_14_invoice','utd_174_invoice_and_waybill','utd_14_invoice_and_waybill','utd_waybill','roaming_utd_174_invoice','roaming_utd_14_invoice','taxcomhub_utd_14_invoice','roaming_utd_174_invoice_and_waybill','roaming_utd_14_invoice_and_waybill','taxcomhub_utd_14_invoice_and_waybill','roaming_utd_waybill','taxcomhub_utd_waybill','connector_utd_invoice','connector_utd_invoice_and_waybill','connector_utd_waybill'],UTD_INVOICE:['utd_174_invoice','utd_14_invoice','roaming_utd_174_invoice','roaming_utd_14_invoice','taxcomhub_utd_14_invoice','connector_utd_invoice'],UTD_WAYBILL:['utd_waybill','roaming_utd_waybill','taxcomhub_utd_waybill','connector_utd_waybill'],UTD_INVOICE_WAYBILL:['utd_174_invoice_and_waybill','utd_14_invoice_and_waybill','roaming_utd_174_invoice_and_waybill','roaming_utd_14_invoice_and_waybill','taxcomhub_utd_14_invoice_and_waybill','connector_utd_invoice_and_waybill'],UCD:['ucd_174_invoice','ucd_14_invoice','ucd_174_invoice_and_waybill','ucd_14_invoice_and_waybill','ucd_waybill','roaming_ucd_174_invoice','roaming_ucd_14_invoice','taxcomhub_ucd_14_invoice','roaming_ucd_174_invoice_and_waybill','roaming_ucd_14_invoice_and_waybill','taxcomhub_ucd_14_invoice_and_waybill','roaming_ucd_waybill','taxcomhub_ucd_waybill','connector_ucd_invoice','connector_ucd_invoice_and_waybill','connector_ucd_waybill'],UCD_INVOICE:['ucd_174_invoice','ucd_14_invoice','roaming_ucd_174_invoice','roaming_ucd_14_invoice','taxcomhub_ucd_14_invoice','connector_ucd_invoice'],UCD_WAYBILL:['ucd_waybill','roaming_ucd_waybill','connector_ucd_waybill','taxcomhub_ucd_waybill'],UCD_INVOICE_WAYBILL:['ucd_174_invoice_and_waybill','ucd_14_invoice_and_waybill','roaming_ucd_174_invoice_and_waybill','roaming_ucd_14_invoice_and_waybill','taxcomhub_ucd_14_invoice_and_waybill','connector_ucd_invoice_and_waybill']};this.search=function(_ref){var _ref$params=_ref.params,params=_ref$params===void 0?{}:_ref$params,offset=_ref.offset,limit=_ref.limit,mode=_ref.mode;var labels=params.labels,isArchival=params.isArchival,createdTo=params.createdTo,createdFrom=params.createdFrom,documentType=params.documentType,packageStatus=params.packageStatus,documentDateTo=params.documentDateTo,documentDateFrom=params.documentDateFrom,contractor=params.contractor,documentNumber=params.documentNumber,externalType=params.externalType,network=params.network,externalOperator=params.externalOperator;var defaultFilter=mode&&mode in _this.defaulFiltered?_this.defaulFiltered[mode]:{};var filter=_objectSpread({},defaultFilter);if(isArchival&&typeof isArchival==='number'){filter['isArchival']=isArchival;}if(labels){filter['labels']=labels;}/** тип контрагента */if(externalType){filter['externalType']=externalType.value;}if(network){filter['network']=network.value;}/** оператор */if(externalOperator){filter['externalOperator']=externalOperator;}/** контрагент, происходит определение ЮЛ или ФЛ и получение id */if(contractor){var _contractor$value,_contractor$value2;var contractorKey='company_contractor';if((contractor===null||contractor===void 0?void 0:(_contractor$value=contractor.value)===null||_contractor$value===void 0?void 0:_contractor$value.type)==='person'||(contractor===null||contractor===void 0?void 0:contractor.type)==='person'){contractorKey='person_contractor';}filter[contractorKey]=parseValue((contractor===null||contractor===void 0?void 0:(_contractor$value2=contractor.value)===null||_contractor$value2===void 0?void 0:_contractor$value2.id)||(contractor===null||contractor===void 0?void 0:contractor.id));}if(documentNumber){filter['documentNumber']=documentNumber;}if(createdFrom){filter['createdAt[from]']=_this.reverseDate(createdFrom);}if(createdTo){filter['createdAt[to]']=_this.reverseDate(createdTo);}if(documentDateFrom){filter['legalDate[from]']=_this.reverseDate(documentDateFrom);}if(documentDateTo){filter['legalDate[to]']=_this.reverseDate(documentDateTo);}if(documentType){filter['documentFlows']=_this.documentFlows.hasOwnProperty(documentType.value)?_this.documentFlows[documentType.value]:[documentType.value];}if(mode&&packageStatus&&packageStatusData[mode]&&packageStatusData[mode][packageStatus.value]){var key=statusData.code;var status=packageStatusData[mode][packageStatus.value];if(Array.isArray(status)){filter[key]=status;}else{key=status.code;filter[key]=status.status;}}else if(['archive','folder'].includes(mode||'')&&packageStatus){var _key=statusData.code;var statusHash=_objectSpread(_objectSpread({},packageStatusData.inbox),packageStatusData.outbox);var _status=statusHash[packageStatus];if(Array.isArray(_status)){filter[_key]=_status;}else{_key=_status.code;filter[_key]=_status.status;}}return DocumentsService.search(filter,offset,limit).then(function(_ref2){var recordsTotal=_ref2.recordsTotal,rows=_ref2.rows;return{recordsTotal:recordsTotal,rows:rows.map(function(item){var docNum=item.document_number?\" \\u2116 \".concat(item.document_number):'';var docDate=item.legal_date?\" \\u043E\\u0442 \".concat(item.legal_date.split(' ')[0]):'';var docName=DocumentsService.getTitle(item.package_flow_system_name,item.document_type_title);var docTitle=[docName,docNum,docDate].filter(Boolean).join(' ');var fromPersonName=[item.from_person_name,item.from_person_patronymic,item.from_person_surname].filter(Boolean).join(' ');var toPersonName=[item.to_person_name,item.to_person_patronymic,item.to_person_surname].filter(Boolean).join(' ');return{id:item.document_id,packageId:item.package_id,packageType:item.package_type,packageState:item.package_state_system_name,fromCompanyName:item.from_company_name,toCompanyName:item.to_company_name,fromPersonName:fromPersonName,toPersonName:toPersonName,documentTitle:docTitle,documentTypeSystemName:item.document_type_system_name,flowType:item.package_flow_system_name,flowGroup:item.package_flow_group,status:item.document_status_system_name,date:item.created_at,isSavedCorrectly:item.is_correct,isRead:item.is_read,containerID:item.container_id,containerSize:item.container_size,labels:item.labels,checked:false,uvutochExist:!!item.uvutoch_exist,fromCompanyExternalOperator:item.from_company_external_operator,fromCompanyExternalType:item.from_company_external_type,fromCompanyNetwork:item.from_company_network,toCompanyExternalOperator:item.to_company_external_operator,toCompanyExternalType:item.to_company_external_type,toCompanyNetwork:item.to_company_network};})};});};this.signDocument=function(documents){return DocumentsService.signAndSendDocuments(documents);};this.signContainer=function(documents){return DocumentsService.signAndSendContainer(documents);};this.download=/*#__PURE__*/function(){var _ref3=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee(ids){var params,url,res,data,date,day,year,month,name;return _regeneratorRuntime.wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:params=ids.map(function(id){return\"ids[]=\".concat(id);}).join('&');url=['/front/document_package/download',params].join('?');_context.next=4;return axios.get(url,{responseType:'blob'});case 4:res=_context.sent;data=res===null||res===void 0?void 0:res.data;if(data){_context.next=8;break;}throw new Error('Возникла ошибка при попыптке скачать.');case 8:date=new Date();day=date.getDate();year=date.getFullYear();month=\"0\".concat(date.getMonth()).slice(-2);name=['Выгрузка',year,month,day].join('-')+'.zip';fileDownload(new Blob([data]),name);return _context.abrupt(\"return\",res);case 15:case\"end\":return _context.stop();}}},_callee);}));return function(_x){return _ref3.apply(this,arguments);};}();}_createClass(DocumentsApi,[{key:\"reverseDate\",value:function reverseDate(date){console.log('date',date);if(/^[\\d]{2}\\.[\\d]{2}\\.[\\d]{4}$/.test(date)===false){return date;}console.log('date2',date);return date.split('.').reverse().join('-');}},{key:\"delete\",value:function _delete(ids){var promises=[];ids.forEach(function(id){promises.push(DocumentsService.delete(id));});return Promise.all(promises);}},{key:\"archive\",value:function archive(ids){return DocumentsService.archive(ids);}}]);return DocumentsApi;}();var DocumentsApiServices=new DocumentsApi();export{DocumentsApiServices};","map":{"version":3,"sources":["C:/Users/Hovsep/Desktop/local/diflow_react/packages/app/src/pages/documents/services/documents.api.tsx"],"names":["axios","DocumentsService","fileDownload","statusData","parseValue","packageStatusData","DocumentsApi","config","method","defaulFiltered","inbox","isArchival","packageTypes","outbox","documentStatuses","archive","draft","documentFlows","ACT_423","ACT","BILATERAL","UNILATERAL","WAYBILL","INVOICE","INVOICE_CORRECTION","UTD","UTD_INVOICE","UTD_WAYBILL","UTD_INVOICE_WAYBILL","UCD","UCD_INVOICE","UCD_WAYBILL","UCD_INVOICE_WAYBILL","search","params","offset","limit","mode","labels","createdTo","createdFrom","documentType","packageStatus","documentDateTo","documentDateFrom","contractor","documentNumber","externalType","network","externalOperator","defaultFilter","filter","value","contractorKey","type","id","reverseDate","hasOwnProperty","key","code","status","Array","isArray","includes","statusHash","then","recordsTotal","rows","map","item","docNum","document_number","docDate","legal_date","split","docName","getTitle","package_flow_system_name","document_type_title","docTitle","Boolean","join","fromPersonName","from_person_name","from_person_patronymic","from_person_surname","toPersonName","to_person_name","to_person_patronymic","to_person_surname","document_id","packageId","package_id","packageType","package_type","packageState","package_state_system_name","fromCompanyName","from_company_name","toCompanyName","to_company_name","documentTitle","documentTypeSystemName","document_type_system_name","flowType","flowGroup","package_flow_group","document_status_system_name","date","created_at","isSavedCorrectly","is_correct","isRead","is_read","containerID","container_id","containerSize","container_size","checked","uvutochExist","uvutoch_exist","fromCompanyExternalOperator","from_company_external_operator","fromCompanyExternalType","from_company_external_type","fromCompanyNetwork","from_company_network","toCompanyExternalOperator","to_company_external_operator","toCompanyExternalType","to_company_external_type","toCompanyNetwork","to_company_network","signDocument","documents","signAndSendDocuments","signContainer","signAndSendContainer","download","ids","url","get","responseType","res","data","Error","Date","day","getDate","year","getFullYear","month","getMonth","slice","name","Blob","console","log","test","reverse","promises","forEach","push","delete","Promise","all","DocumentsApiServices"],"mappings":"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","sourcesContent":["import axios, { AxiosRequestConfig } from 'axios';\r\nimport DocumentsService from '@distate/core/dist/application/documents/common/DocumentsService';\r\nimport fileDownload from 'js-file-download';\r\n\r\nimport statusData from '../helpers/documents.status';\r\nimport { parseValue } from '../helpers/documnets.helpers';\r\n\r\ntype ResponseRow = {\r\n  recordsTotal: number;\r\n  rows: any;\r\n};\r\n\r\ntype RequestSearch = {\r\n  params?: {\r\n    isArchival?: number | boolean | null;\r\n    labels?: any[];\r\n    contractor?: any;\r\n    createdTo?: string;\r\n    createdFrom?: string;\r\n    documentType?: any;\r\n    documentNumber?: string | number;\r\n    packageStatus?: any;\r\n    documentDateTo?: string;\r\n    documentDateFrom?: string;\r\n    [name: string]: any;\r\n  };\r\n  offset?: number;\r\n  limit?: number;\r\n  mode?: string;\r\n};\r\n\r\nconst packageStatusData: any = statusData;\r\n\r\nclass DocumentsApi {\r\n  config: AxiosRequestConfig = {\r\n    method: 'get'\r\n  };\r\n\r\n  defaulFiltered: Record<string, any> = {\r\n    inbox: { isArchival: 0, packageTypes: ['IN'] },\r\n    outbox: { isArchival: 0, packageTypes: ['OUT'], documentStatuses: ['sent'] },\r\n    archive: { isArchival: 1 },\r\n    draft: {\r\n      isArchival: 0,\r\n      packageTypes: ['OUT'],\r\n      documentStatuses: ['draft', 'signed']\r\n    }\r\n  };\r\n\r\n  documentFlows: any = {\r\n    ACT_423: ['act_423', 'roaming_act_423'],\r\n    ACT: ['act', 'act_552', 'roaming_act_552', 'taxcomhub_act_552'],\r\n    BILATERAL: ['bilateral', 'roaming_unformalized_bilateral', 'connector_unformalized_bilateral'],\r\n    UNILATERAL: [\r\n      'unilateral',\r\n      'roaming_unformalized_unilateral',\r\n      'connector_unformalized_unilateral'\r\n    ],\r\n    WAYBILL: ['waybill', 'waybill_551', 'roaming_waybill_551', 'taxcomhub_waybill_551'],\r\n    INVOICE: ['invoice', 'invoice_utd_174', 'invoice_utd_14'],\r\n    INVOICE_CORRECTION: [\r\n      'invoice_correction',\r\n      'invoice_correction_ucd_174',\r\n      'invoice_correction_ucd_14'\r\n    ],\r\n    UTD: [\r\n      'utd_174_invoice',\r\n      'utd_14_invoice',\r\n      'utd_174_invoice_and_waybill',\r\n      'utd_14_invoice_and_waybill',\r\n      'utd_waybill',\r\n      'roaming_utd_174_invoice',\r\n      'roaming_utd_14_invoice',\r\n      'taxcomhub_utd_14_invoice',\r\n      'roaming_utd_174_invoice_and_waybill',\r\n      'roaming_utd_14_invoice_and_waybill',\r\n      'taxcomhub_utd_14_invoice_and_waybill',\r\n      'roaming_utd_waybill',\r\n      'taxcomhub_utd_waybill',\r\n      'connector_utd_invoice',\r\n      'connector_utd_invoice_and_waybill',\r\n      'connector_utd_waybill'\r\n    ],\r\n    UTD_INVOICE: [\r\n      'utd_174_invoice',\r\n      'utd_14_invoice',\r\n      'roaming_utd_174_invoice',\r\n      'roaming_utd_14_invoice',\r\n      'taxcomhub_utd_14_invoice',\r\n      'connector_utd_invoice'\r\n    ],\r\n    UTD_WAYBILL: [\r\n      'utd_waybill',\r\n      'roaming_utd_waybill',\r\n      'taxcomhub_utd_waybill',\r\n      'connector_utd_waybill'\r\n    ],\r\n    UTD_INVOICE_WAYBILL: [\r\n      'utd_174_invoice_and_waybill',\r\n      'utd_14_invoice_and_waybill',\r\n      'roaming_utd_174_invoice_and_waybill',\r\n      'roaming_utd_14_invoice_and_waybill',\r\n      'taxcomhub_utd_14_invoice_and_waybill',\r\n      'connector_utd_invoice_and_waybill'\r\n    ],\r\n    UCD: [\r\n      'ucd_174_invoice',\r\n      'ucd_14_invoice',\r\n      'ucd_174_invoice_and_waybill',\r\n      'ucd_14_invoice_and_waybill',\r\n      'ucd_waybill',\r\n      'roaming_ucd_174_invoice',\r\n      'roaming_ucd_14_invoice',\r\n      'taxcomhub_ucd_14_invoice',\r\n      'roaming_ucd_174_invoice_and_waybill',\r\n      'roaming_ucd_14_invoice_and_waybill',\r\n      'taxcomhub_ucd_14_invoice_and_waybill',\r\n      'roaming_ucd_waybill',\r\n      'taxcomhub_ucd_waybill',\r\n      'connector_ucd_invoice',\r\n      'connector_ucd_invoice_and_waybill',\r\n      'connector_ucd_waybill'\r\n    ],\r\n    UCD_INVOICE: [\r\n      'ucd_174_invoice',\r\n      'ucd_14_invoice',\r\n      'roaming_ucd_174_invoice',\r\n      'roaming_ucd_14_invoice',\r\n      'taxcomhub_ucd_14_invoice',\r\n      'connector_ucd_invoice'\r\n    ],\r\n    UCD_WAYBILL: [\r\n      'ucd_waybill',\r\n      'roaming_ucd_waybill',\r\n      'connector_ucd_waybill',\r\n      'taxcomhub_ucd_waybill'\r\n    ],\r\n    UCD_INVOICE_WAYBILL: [\r\n      'ucd_174_invoice_and_waybill',\r\n      'ucd_14_invoice_and_waybill',\r\n      'roaming_ucd_174_invoice_and_waybill',\r\n      'roaming_ucd_14_invoice_and_waybill',\r\n      'taxcomhub_ucd_14_invoice_and_waybill',\r\n      'connector_ucd_invoice_and_waybill'\r\n    ]\r\n  };\r\n\r\n  reverseDate(date: string): string {\r\n    console.log('date', date);\r\n    if (/^[\\d]{2}\\.[\\d]{2}\\.[\\d]{4}$/.test(date) === false) {\r\n      return date;\r\n    }\r\n    console.log('date2', date);\r\n\r\n    return date\r\n      .split('.')\r\n      .reverse()\r\n      .join('-');\r\n  }\r\n\r\n  search = ({ params = {}, offset, limit, mode }: RequestSearch) => {\r\n    const {\r\n      labels,\r\n      isArchival,\r\n      createdTo,\r\n      createdFrom,\r\n      documentType,\r\n      packageStatus,\r\n      documentDateTo,\r\n      documentDateFrom,\r\n      contractor,\r\n      documentNumber,\r\n      externalType,\r\n      network,\r\n      externalOperator\r\n    } = params;\r\n\r\n    const defaultFilter = mode && mode in this.defaulFiltered ? this.defaulFiltered[mode] : {};\r\n    const filter = { ...defaultFilter };\r\n\r\n    if (isArchival && typeof isArchival === 'number') {\r\n      filter['isArchival'] = isArchival;\r\n    }\r\n\r\n    if (labels) {\r\n      filter['labels'] = labels;\r\n    }\r\n\r\n    /** тип контрагента */\r\n    if (externalType) {\r\n      filter['externalType'] = externalType.value;\r\n    }\r\n\r\n    if (network) {\r\n      filter['network'] = network.value;\r\n    }\r\n\r\n    /** оператор */\r\n    if (externalOperator) {\r\n      filter['externalOperator'] = externalOperator;\r\n    }\r\n\r\n    /** контрагент, происходит определение ЮЛ или ФЛ и получение id */\r\n    if (contractor) {\r\n      let contractorKey = 'company_contractor';\r\n      if (contractor?.value?.type === 'person' || contractor?.type === 'person') {\r\n        contractorKey = 'person_contractor';\r\n      }\r\n\r\n      filter[contractorKey] = parseValue(contractor?.value?.id || contractor?.id);\r\n    }\r\n\r\n    if (documentNumber) {\r\n      filter['documentNumber'] = documentNumber;\r\n    }\r\n\r\n    if (createdFrom) {\r\n      filter['createdAt[from]'] = this.reverseDate(createdFrom);\r\n    }\r\n\r\n    if (createdTo) {\r\n      filter['createdAt[to]'] = this.reverseDate(createdTo);\r\n    }\r\n\r\n    if (documentDateFrom) {\r\n      filter['legalDate[from]'] = this.reverseDate(documentDateFrom);\r\n    }\r\n\r\n    if (documentDateTo) {\r\n      filter['legalDate[to]'] = this.reverseDate(documentDateTo);\r\n    }\r\n\r\n    if (documentType) {\r\n      filter['documentFlows'] = this.documentFlows.hasOwnProperty(documentType.value)\r\n        ? this.documentFlows[documentType.value]\r\n        : [documentType.value];\r\n    }\r\n\r\n    if (\r\n      mode &&\r\n      packageStatus &&\r\n      packageStatusData[mode] &&\r\n      packageStatusData[mode][packageStatus.value]\r\n    ) {\r\n      let key = statusData.code;\r\n      const status = packageStatusData[mode][packageStatus.value];\r\n      if (Array.isArray(status)) {\r\n        filter[key] = status;\r\n      } else {\r\n        key = status.code;\r\n        filter[key] = status.status;\r\n      }\r\n    } else if (['archive', 'folder'].includes(mode || '') && packageStatus) {\r\n      let key = statusData.code;\r\n      const statusHash = { ...packageStatusData.inbox, ...packageStatusData.outbox };\r\n      const status = statusHash[packageStatus];\r\n      if (Array.isArray(status)) {\r\n        filter[key] = status;\r\n      } else {\r\n        key = status.code;\r\n        filter[key] = status.status;\r\n      }\r\n    }\r\n\r\n    return DocumentsService.search(filter, offset, limit).then(\r\n      ({ recordsTotal, rows }: ResponseRow): ResponseRow => {\r\n        return {\r\n          recordsTotal,\r\n          rows: rows.map((item: any) => {\r\n            const docNum = item.document_number ? ` № ${item.document_number}` : '';\r\n            const docDate = item.legal_date ? ` от ${item.legal_date.split(' ')[0]}` : '';\r\n            const docName = DocumentsService.getTitle(\r\n              item.package_flow_system_name,\r\n              item.document_type_title\r\n            );\r\n\r\n            const docTitle = [docName, docNum, docDate].filter(Boolean).join(' ');\r\n            const fromPersonName = [\r\n              item.from_person_name,\r\n              item.from_person_patronymic,\r\n              item.from_person_surname\r\n            ]\r\n              .filter(Boolean)\r\n              .join(' ');\r\n\r\n            const toPersonName = [\r\n              item.to_person_name,\r\n              item.to_person_patronymic,\r\n              item.to_person_surname\r\n            ]\r\n              .filter(Boolean)\r\n              .join(' ');\r\n\r\n            return {\r\n              id: item.document_id,\r\n              packageId: item.package_id,\r\n              packageType: item.package_type,\r\n              packageState: item.package_state_system_name,\r\n              fromCompanyName: item.from_company_name,\r\n              toCompanyName: item.to_company_name,\r\n              fromPersonName,\r\n              toPersonName,\r\n              documentTitle: docTitle,\r\n              documentTypeSystemName: item.document_type_system_name,\r\n              flowType: item.package_flow_system_name,\r\n              flowGroup: item.package_flow_group,\r\n              status: item.document_status_system_name,\r\n              date: item.created_at,\r\n              isSavedCorrectly: item.is_correct,\r\n              isRead: item.is_read,\r\n              containerID: item.container_id,\r\n              containerSize: item.container_size,\r\n              labels: item.labels,\r\n              checked: false,\r\n              uvutochExist: !!item.uvutoch_exist,\r\n              fromCompanyExternalOperator: item.from_company_external_operator,\r\n              fromCompanyExternalType: item.from_company_external_type,\r\n              fromCompanyNetwork: item.from_company_network,\r\n              toCompanyExternalOperator: item.to_company_external_operator,\r\n              toCompanyExternalType: item.to_company_external_type,\r\n              toCompanyNetwork: item.to_company_network\r\n            };\r\n          })\r\n        };\r\n      }\r\n    );\r\n  };\r\n\r\n  delete(ids: string[]) {\r\n    const promises: any[] = [];\r\n\r\n    ids.forEach(id => {\r\n      promises.push(DocumentsService.delete(id));\r\n    });\r\n\r\n    return Promise.all(promises);\r\n  }\r\n\r\n  archive(ids: string[]) {\r\n    return DocumentsService.archive(ids);\r\n  }\r\n\r\n  signDocument = (documents: any[]) => {\r\n    return DocumentsService.signAndSendDocuments(documents);\r\n  };\r\n\r\n  signContainer = (documents: any[]) => {\r\n    return DocumentsService.signAndSendContainer(documents);\r\n  };\r\n\r\n  download = async (ids: string[]) => {\r\n    const params = ids.map(id => `ids[]=${id}`).join('&');\r\n    const url = ['/front/document_package/download', params].join('?');\r\n\r\n    const res = await axios.get(url, { responseType: 'blob' });\r\n    const data = res?.data;\r\n    if (!data) {\r\n      throw new Error('Возникла ошибка при попыптке скачать.');\r\n    }\r\n\r\n    const date = new Date();\r\n    const day = date.getDate();\r\n    const year = date.getFullYear();\r\n    const month = `0${date.getMonth()}`.slice(-2);\r\n\r\n    const name = ['Выгрузка', year, month, day].join('-') + '.zip';\r\n\r\n    fileDownload(new Blob([data]), name);\r\n\r\n    return res;\r\n  };\r\n}\r\n\r\nconst DocumentsApiServices = new DocumentsApi();\r\nexport { DocumentsApiServices };\r\n"]},"metadata":{},"sourceType":"module"}