{"ast":null,"code":"import _slicedToArray from\"C:\\\\Users\\\\Hovsep\\\\Desktop\\\\local\\\\diflow_react\\\\node_modules\\\\babel-preset-react-app\\\\node_modules\\\\@babel\\\\runtime/helpers/esm/slicedToArray\";import _toConsumableArray from\"C:\\\\Users\\\\Hovsep\\\\Desktop\\\\local\\\\diflow_react\\\\node_modules\\\\babel-preset-react-app\\\\node_modules\\\\@babel\\\\runtime/helpers/esm/toConsumableArray\";import _classCallCheck from\"C:\\\\Users\\\\Hovsep\\\\Desktop\\\\local\\\\diflow_react\\\\node_modules\\\\babel-preset-react-app\\\\node_modules\\\\@babel\\\\runtime/helpers/esm/classCallCheck\";import _createClass from\"C:\\\\Users\\\\Hovsep\\\\Desktop\\\\local\\\\diflow_react\\\\node_modules\\\\babel-preset-react-app\\\\node_modules\\\\@babel\\\\runtime/helpers/esm/createClass\";import React from'react';import{ArrayField}from'informed';import{LEFT,RIGHT}from'../../Placement';import Behavior from'../parameters/Behavior';import Appearance from'../parameters/Appearance';import classNames from'classnames';import{capitalize}from'../../../utils/StringUtil';import get from'get-value';import TotalCostBeforeTax from'@distate/core/dist/domain/documents/upd/vo/total/TotalCostBeforeTax';import TotalCostAfterTax from'@distate/core/dist/domain/documents/upd/vo/total/TotalCostAfterTax';import TotalAmountOfTax from'@distate/core/dist/domain/documents/upd/vo/total/TotalAmountOfTax';import{format as formatMoney}from'../../../utils/MoneyUtil';import{del}from'object-path-immutable';var DocumentTable=/*#__PURE__*/function(){_createClass(DocumentTable,null,[{key:\"createTDClasses\",value:function createTDClasses(){var formApi=arguments.length>0&&arguments[0]!==undefined?arguments[0]:null;var field=arguments.length>1&&arguments[1]!==undefined?arguments[1]:'';var customClasses=arguments.length>2&&arguments[2]!==undefined?arguments[2]:['input'];if(!formApi)return classNames(customClasses);var getError=formApi.getError,getTouched=formApi.getTouched,getValue=formApi.getValue;var res={};if(field){res.error=getError(field);res.success=!getError(field)&&getTouched(field)&&getValue(field);}return classNames(res,customClasses);}}]);function DocumentTable(GroupDomainVO,styles,behavior,behaviours,appearances,errors){_classCallCheck(this,DocumentTable);this._groupDomainVO=GroupDomainVO;this._styles=styles;this._behavior=behavior;this._behaviours=behaviours;this._appearances=appearances;this._errors=errors;}_createClass(DocumentTable,[{key:\"createTableHead\",value:function createTableHead(){var _this=this;return/*#__PURE__*/React.createElement(React.Fragment,null,/*#__PURE__*/React.createElement(\"colgroup\",null,/*#__PURE__*/React.createElement(\"col\",null),this._groupDomainVO.VOs.map(function(vo){if(_this._widths[vo.field]){return/*#__PURE__*/React.createElement(\"col\",{width:_this._widths[vo.field],key:\"\".concat(vo.field)});}else{return/*#__PURE__*/React.createElement(\"col\",{key:\"\".concat(vo.field)});}})),/*#__PURE__*/React.createElement(\"thead\",null,/*#__PURE__*/React.createElement(\"tr\",null,/*#__PURE__*/React.createElement(\"th\",null,\"\\u2116\"),this._groupDomainVO.VOs.map(function(vo){var noCaption=get(_this._appearances[vo.field],'noCaption');return/*#__PURE__*/React.createElement(\"th\",{key:\"\".concat(vo.field)},!noCaption&&vo.name);}),/*#__PURE__*/React.createElement(\"th\",{colSpan:\"2\"}))));}},{key:\"createRow\",value:function createRow(createElementsMap,index,add,remove,key,fields){var _this2=this;var totals=arguments.length>6&&arguments[6]!==undefined?arguments[6]:{};var clone=function clone(){// TODO реализовать клонирование ячейки\nadd();};var onTotalChange=function onTotalChange(DomainVO){return function(){var aggregatedResult;if(fields.length){var _totals$DomainVO$fiel;var values=fields.map(function(_ref){var field=_ref.field;return _this2._formAPI.getValue(\"\".concat(field,\".\").concat(DomainVO.field));});aggregatedResult=formatMoney((_totals$DomainVO$fiel=totals[DomainVO.field].domain).calculate.apply(_totals$DomainVO$fiel,_toConsumableArray(values)));_this2._formAPI.setValue(totals[DomainVO.field].domain.field,aggregatedResult);}};};return/*#__PURE__*/React.createElement(\"tr\",{className:\"tr-good\",key:key},/*#__PURE__*/React.createElement(\"td\",{className:this._styles.center},/*#__PURE__*/React.createElement(\"span\",null,index+1)),this._groupDomainVO.VOs.map(function(DomainVO){if(!createElementsMap[DomainVO.field]){throw new Error(\"\\u0417\\u0430\\u0431\\u044B\\u043B\\u0438 \\u0437\\u0430\\u0434\\u0430\\u0442\\u044C \\u043A\\u043E\\u043D\\u0444\\u0438\\u0433\\u0443\\u0440\\u0430\\u0446\\u0438\\u044E \\u0434\\u043B\\u044F \\u043F\\u043E\\u043B\\u044F \".concat(DomainVO.field,\" \\u0432 \\u0442\\u0430\\u0431\\u043B\\u0438\\u0446\\u0435\"));}var _ref2=_this2._behaviours[DomainVO.field]||{},scope=_ref2.scope,dataAttributeSelector=_ref2.dataAttributeSelector,componentStateAdditionalDataConfig=_ref2.componentStateAdditionalDataConfig,modalBuilder=_ref2.modalBuilder,showErrorMsg=_ref2.showErrorMsg,_ref2$onChange=_ref2.onChange,onChange=_ref2$onChange===void 0?function(){}:_ref2$onChange,customFieldName=_ref2.customFieldName;var fieldScope=scope||DomainVO.field;var field=\"\".concat(_this2._groupDomainVO.field,\"[\").concat(index,\"].\").concat(fieldScope);var inputBuilder=createElementsMap[DomainVO.field].build;var customClasses=['input'];var error=get(_this2._errors,\"[\".concat(index,\"].\").concat(DomainVO.field,\".errors[0]\"));if(error)customClasses.push('error');var tdClasses=DocumentTable.createTDClasses(_this2._formAPI,field,customClasses);var initialFieldDomainValue=_this2._component.props.id?undefined:'';return/*#__PURE__*/React.createElement(\"td\",{className:tdClasses,key:\"\".concat(key,\"_\").concat(DomainVO.field)},inputBuilder(_this2._groupDomainVO,DomainVO,index,new Behavior({initialFieldDomain:{value:initialFieldDomainValue},onChange:totals[DomainVO.field]?onTotalChange(DomainVO):function(event){var _event$target;return onChange(index,event===null||event===void 0?void 0:(_event$target=event.target)===null||_event$target===void 0?void 0:_event$target.value);},scope:fieldScope,dataAttributeSelector:dataAttributeSelector,componentStateAdditionalDataConfig:componentStateAdditionalDataConfig,modalBuilder:modalBuilder,showErrorMsg:showErrorMsg,index:index,customFieldName:customFieldName}),new Appearance({customClasses:'',align:LEFT,width:'auto'}))());}),/*#__PURE__*/React.createElement(\"td\",{className:\"table-clone\"},/*#__PURE__*/React.createElement(\"button\",{type:\"button\",className:\"ds-button icon-clone solid\",onClick:function onClick(){return clone();}})),/*#__PURE__*/React.createElement(\"td\",{className:\"table-remove\"},/*#__PURE__*/React.createElement(\"button\",{type:\"button\",className:\"ds-button icon-delete solid\",onClick:function onClick(){return remove();}})));}},{key:\"groupRows\",value:function groupRows(createElementsMap,fields,add,totals){var _this3=this;var removeRow=function removeRow(index){return function(){var isLastRowLeft=index===0&&fields.length===1;if(isLastRowLeft){_this3._groupDomainVO.VOs.forEach(function(DomainVO){var fieldBehaviour=_this3._behaviours[DomainVO.field];var scope=fieldBehaviour&&fieldBehaviour.scope?fieldBehaviour.scope:DomainVO.field;var fieldToClear=\"\".concat(_this3._groupDomainVO.field,\"[0].\").concat(scope);var blankValue=DomainVO.options?DomainVO.options[0].value:'';if(_this3._formAPI.getValue(fieldToClear)){_this3._formAPI.setValue(\"\".concat(TotalCostBeforeTax.field),'');_this3._formAPI.setValue(\"\".concat(TotalCostAfterTax.field),'');_this3._formAPI.setValue(\"\".concat(TotalAmountOfTax.field),'');_this3._formAPI.setValue(fieldToClear,blankValue);}});}else{fields[index].remove();var componentState=del(_this3._componentState,\"\".concat(_this3._groupDomainVO.field,\".\").concat(index));_this3._component.setState(componentState);var onChange=_this3._behavior.onChange;if(onChange)onChange(index,true);}};};return fields.map(function(field,index){return _this3.createRow(createElementsMap,index,add,removeRow(index),field.key,fields,totals);});}},{key:\"createTableContent\",value:function createTableContent(createElementsMap,footerConfig){var _this4=this;var totals={};Object.entries(createElementsMap).forEach(function(_ref3){var _ref4=_slicedToArray(_ref3,2),key=_ref4[0],value=_ref4[1];if(value.aggregatedBy){totals[key]=value.aggregatedBy;}});return/*#__PURE__*/React.createElement(ArrayField,{field:this._groupDomainVO.field},function(_ref5){var add=_ref5.add,fields=_ref5.fields;return/*#__PURE__*/React.createElement(React.Fragment,null,/*#__PURE__*/React.createElement(\"tbody\",null,_this4.groupRows(createElementsMap,fields,add,totals)),_this4.createTableFooter(footerConfig,fields,add,_this4._groupDomainVO.field,totals));});}},{key:\"createTableFooter\",value:function createTableFooter(footerConfig,fields,add,key,total){var _this5=this;var createFooterColumns=function createFooterColumns(){var _footerConfig$initial;var result=[];var colspanAcc=0;var createEmptyTd=function createEmptyTd(colspan,label,index){return/*#__PURE__*/React.createElement(\"td\",{key:\"empty_\".concat(key,\"_\").concat(index),colSpan:colspan,align:RIGHT,className:_this5._styles.paddingRight},label);};var labels=_toConsumableArray(footerConfig.labels);var initValues=(_footerConfig$initial=footerConfig.initialFieldDomain)===null||_footerConfig$initial===void 0?void 0:_footerConfig$initial.value;_this5._groupDomainVO.VOs.forEach(function(vo,index){if(index<1)return;if(total[vo.field]){if(colspanAcc>0){result.push(createEmptyTd(colspanAcc,labels.shift(),index));colspanAcc=0;}result.push(/*#__PURE__*/React.createElement(\"td\",{key:\"total_\".concat(key,\"_\").concat(index)},total[vo.field].build(total[vo.field].domain,new Behavior({initialFieldDomain:{value:get(initValues,\"total\".concat(capitalize(vo.field)))}}))));}else{colspanAcc++;}});if(colspanAcc>0){result.push(createEmptyTd(colspanAcc));colspanAcc=0;}return result;};return/*#__PURE__*/React.createElement(\"tfoot\",{key:key},/*#__PURE__*/React.createElement(\"tr\",null,/*#__PURE__*/React.createElement(\"td\",{className:\"table-add\",colSpan:\"2\"},/*#__PURE__*/React.createElement(\"button\",{type:\"button\",className:\"ds-button icon-add\",onClick:function onClick(){return add();}},\"\\u0414\\u043E\\u0431\\u0430\\u0432\\u0438\\u0442\\u044C \\u0437\\u0430\\u043F\\u0438\\u0441\\u044C\")),createFooterColumns(),/*#__PURE__*/React.createElement(\"td\",{className:\"table-add\",colSpan:\"2\"})));}},{key:\"create\",value:function create(createElementsMap,footerConfig,tableAppearance,formState,formAPI,component){var _this6=this;this._formState=formState;this._formAPI=formAPI;this._component=component;this._componentState=component.state;this._widths={};Object.keys(tableAppearance).forEach(function(field){return _this6._widths[field]=tableAppearance[field].width;});var showTableErrorMsg=this._formAPI.getError(this._groupDomainVO.field);return/*#__PURE__*/React.createElement(React.Fragment,null,/*#__PURE__*/React.createElement(\"br\",null),showTableErrorMsg&&/*#__PURE__*/React.createElement(\"label\",{className:\"ds-field-name top color-danger width-auto\"},\"\\u041F\\u0440\\u043E\\u0432\\u0435\\u0440\\u044C\\u0442\\u0435 \\u043F\\u0440\\u0430\\u0432\\u0438\\u043B\\u044C\\u043D\\u043E\\u0441\\u0442\\u044C \\u0437\\u0430\\u043F\\u043E\\u043B\\u043D\\u0435\\u043D\\u0438\\u044F \\u0442\\u0430\\u0431\\u043B\\u0438\\u0446\\u044B\"),/*#__PURE__*/React.createElement(\"table\",{className:\"table-editor\"},this.createTableHead(),this.createTableContent(createElementsMap,footerConfig)));}}]);return DocumentTable;}();export default DocumentTable;","map":{"version":3,"sources":["C:/Users/Hovsep/Desktop/local/diflow_react/packages/app/src/common/form/components/DocumentTable.js"],"names":["React","ArrayField","LEFT","RIGHT","Behavior","Appearance","classNames","capitalize","get","TotalCostBeforeTax","TotalCostAfterTax","TotalAmountOfTax","format","formatMoney","del","DocumentTable","formApi","field","customClasses","getError","getTouched","getValue","res","error","success","GroupDomainVO","styles","behavior","behaviours","appearances","errors","_groupDomainVO","_styles","_behavior","_behaviours","_appearances","_errors","VOs","map","vo","_widths","noCaption","name","createElementsMap","index","add","remove","key","fields","totals","clone","onTotalChange","DomainVO","aggregatedResult","length","values","_formAPI","domain","calculate","setValue","center","Error","scope","dataAttributeSelector","componentStateAdditionalDataConfig","modalBuilder","showErrorMsg","onChange","customFieldName","fieldScope","inputBuilder","build","push","tdClasses","createTDClasses","initialFieldDomainValue","_component","props","id","undefined","initialFieldDomain","value","event","target","align","width","removeRow","isLastRowLeft","forEach","fieldBehaviour","fieldToClear","blankValue","options","componentState","_componentState","setState","createRow","footerConfig","Object","entries","aggregatedBy","groupRows","createTableFooter","total","createFooterColumns","result","colspanAcc","createEmptyTd","colspan","label","paddingRight","labels","initValues","shift","tableAppearance","formState","formAPI","component","_formState","state","keys","showTableErrorMsg","createTableHead","createTableContent"],"mappings":"krBAAA,MAAOA,CAAAA,KAAP,KAAkB,OAAlB,CACA,OAASC,UAAT,KAA2B,UAA3B,CACA,OAASC,IAAT,CAAeC,KAAf,KAA4B,iBAA5B,CACA,MAAOC,CAAAA,QAAP,KAAqB,wBAArB,CACA,MAAOC,CAAAA,UAAP,KAAuB,0BAAvB,CACA,MAAOC,CAAAA,UAAP,KAAuB,YAAvB,CACA,OAASC,UAAT,KAA2B,2BAA3B,CACA,MAAOC,CAAAA,GAAP,KAAgB,WAAhB,CACA,MAAOC,CAAAA,kBAAP,KAA+B,qEAA/B,CACA,MAAOC,CAAAA,iBAAP,KAA8B,oEAA9B,CACA,MAAOC,CAAAA,gBAAP,KAA6B,mEAA7B,CACA,OAASC,MAAM,GAAIC,CAAAA,WAAnB,KAAsC,0BAAtC,CACA,OAASC,GAAT,KAAoB,uBAApB,C,GAEMC,CAAAA,a,iHAC0E,IAAvDC,CAAAA,OAAuD,2DAA7C,IAA6C,IAAvCC,CAAAA,KAAuC,2DAA/B,EAA+B,IAA3BC,CAAAA,aAA2B,2DAAX,CAAC,OAAD,CAAW,CAC5E,GAAI,CAACF,OAAL,CAAc,MAAOV,CAAAA,UAAU,CAACY,aAAD,CAAjB,CAD8D,GAEpEC,CAAAA,QAFoE,CAEjCH,OAFiC,CAEpEG,QAFoE,CAE1DC,UAF0D,CAEjCJ,OAFiC,CAE1DI,UAF0D,CAE9CC,QAF8C,CAEjCL,OAFiC,CAE9CK,QAF8C,CAG5E,GAAMC,CAAAA,GAAG,CAAG,EAAZ,CACA,GAAIL,KAAJ,CAAW,CACTK,GAAG,CAACC,KAAJ,CAAYJ,QAAQ,CAACF,KAAD,CAApB,CACAK,GAAG,CAACE,OAAJ,CAAc,CAACL,QAAQ,CAACF,KAAD,CAAT,EAAoBG,UAAU,CAACH,KAAD,CAA9B,EAAyCI,QAAQ,CAACJ,KAAD,CAA/D,CACD,CACD,MAAOX,CAAAA,UAAU,CAACgB,GAAD,CAAMJ,aAAN,CAAjB,CACD,C,IAED,uBAAYO,aAAZ,CAA2BC,MAA3B,CAAmCC,QAAnC,CAA6CC,UAA7C,CAAyDC,WAAzD,CAAsEC,MAAtE,CAA8E,qCAC5E,KAAKC,cAAL,CAAsBN,aAAtB,CACA,KAAKO,OAAL,CAAeN,MAAf,CACA,KAAKO,SAAL,CAAiBN,QAAjB,CACA,KAAKO,WAAL,CAAmBN,UAAnB,CACA,KAAKO,YAAL,CAAoBN,WAApB,CACA,KAAKO,OAAL,CAAeN,MAAf,CACD,C,mFAEiB,gBAChB,mBACE,oBAAC,KAAD,CAAO,QAAP,mBACE,iDACE,+BADF,CAEG,KAAKC,cAAL,CAAoBM,GAApB,CAAwBC,GAAxB,CAA4B,SAAAC,EAAE,CAAI,CACjC,GAAI,KAAI,CAACC,OAAL,CAAaD,EAAE,CAACtB,KAAhB,CAAJ,CAA4B,CAC1B,mBAAO,2BAAK,KAAK,CAAE,KAAI,CAACuB,OAAL,CAAaD,EAAE,CAACtB,KAAhB,CAAZ,CAAoC,GAAG,WAAKsB,EAAE,CAACtB,KAAR,CAAvC,EAAP,CACD,CAFD,IAEO,CACL,mBAAO,2BAAK,GAAG,WAAKsB,EAAE,CAACtB,KAAR,CAAR,EAAP,CACD,CACF,CANA,CAFH,CADF,cAWE,8CACE,2CACE,uCADF,CAEG,KAAKc,cAAL,CAAoBM,GAApB,CAAwBC,GAAxB,CAA4B,SAAAC,EAAE,CAAI,CACjC,GAAME,CAAAA,SAAS,CAAGjC,GAAG,CAAC,KAAI,CAAC2B,YAAL,CAAkBI,EAAE,CAACtB,KAArB,CAAD,CAA8B,WAA9B,CAArB,CACA,mBAAO,0BAAI,GAAG,WAAKsB,EAAE,CAACtB,KAAR,CAAP,EAAyB,CAACwB,SAAD,EAAcF,EAAE,CAACG,IAA1C,CAAP,CACD,CAHA,CAFH,cAME,0BAAI,OAAO,CAAC,GAAZ,EANF,CADF,CAXF,CADF,CAwBD,C,4CAESC,iB,CAAmBC,K,CAAOC,G,CAAKC,M,CAAQC,G,CAAKC,M,CAAqB,oBAAbC,CAAAA,MAAa,2DAAJ,EAAI,CACzE,GAAMC,CAAAA,KAAK,CAAG,QAARA,CAAAA,KAAQ,EAAM,CAClB;AACAL,GAAG,GACJ,CAHD,CAIA,GAAMM,CAAAA,aAAa,CAAG,QAAhBA,CAAAA,aAAgB,CAAAC,QAAQ,QAAI,WAAM,CACtC,GAAIC,CAAAA,gBAAJ,CACA,GAAIL,MAAM,CAACM,MAAX,CAAmB,2BACjB,GAAMC,CAAAA,MAAM,CAAGP,MAAM,CAACV,GAAP,CAAW,cAAe,IAAZrB,CAAAA,KAAY,MAAZA,KAAY,CACvC,MAAO,CAAA,MAAI,CAACuC,QAAL,CAAcnC,QAAd,WAA0BJ,KAA1B,aAAmCmC,QAAQ,CAACnC,KAA5C,EAAP,CACD,CAFc,CAAf,CAGAoC,gBAAgB,CAAGxC,WAAW,CAAC,uBAAAoC,MAAM,CAACG,QAAQ,CAACnC,KAAV,CAAN,CAAuBwC,MAAvB,EAA8BC,SAA9B,gDAA2CH,MAA3C,EAAD,CAA9B,CACA,MAAI,CAACC,QAAL,CAAcG,QAAd,CAAuBV,MAAM,CAACG,QAAQ,CAACnC,KAAV,CAAN,CAAuBwC,MAAvB,CAA8BxC,KAArD,CAA4DoC,gBAA5D,EACD,CACF,CAT6B,EAA9B,CAUA,mBACE,0BAAI,SAAS,CAAC,SAAd,CAAwB,GAAG,CAAEN,GAA7B,eACE,0BAAI,SAAS,CAAE,KAAKf,OAAL,CAAa4B,MAA5B,eACE,gCAAOhB,KAAK,CAAG,CAAf,CADF,CADF,CAKG,KAAKb,cAAL,CAAoBM,GAApB,CAAwBC,GAAxB,CAA4B,SAAAc,QAAQ,CAAI,CACvC,GAAI,CAACT,iBAAiB,CAACS,QAAQ,CAACnC,KAAV,CAAtB,CAAwC,CACtC,KAAM,IAAI4C,CAAAA,KAAJ,0MAAiDT,QAAQ,CAACnC,KAA1D,uDAAN,CACD,CAHsC,UAYnC,MAAI,CAACiB,WAAL,CAAiBkB,QAAQ,CAACnC,KAA1B,GAAoC,EAZD,CAKrC6C,KALqC,OAKrCA,KALqC,CAMrCC,qBANqC,OAMrCA,qBANqC,CAOrCC,kCAPqC,OAOrCA,kCAPqC,CAQrCC,YARqC,OAQrCA,YARqC,CASrCC,YATqC,OASrCA,YATqC,sBAUrCC,QAVqC,CAUrCA,QAVqC,yBAU1B,UAAM,CAAE,CAVkB,gBAWrCC,eAXqC,OAWrCA,eAXqC,CAavC,GAAMC,CAAAA,UAAU,CAAGP,KAAK,EAAIV,QAAQ,CAACnC,KAArC,CACA,GAAMA,CAAAA,KAAK,WAAM,MAAI,CAACc,cAAL,CAAoBd,KAA1B,aAAmC2B,KAAnC,cAA6CyB,UAA7C,CAAX,CACA,GAAMC,CAAAA,YAAY,CAAG3B,iBAAiB,CAACS,QAAQ,CAACnC,KAAV,CAAjB,CAAkCsD,KAAvD,CACA,GAAMrD,CAAAA,aAAa,CAAG,CAAC,OAAD,CAAtB,CACA,GAAMK,CAAAA,KAAK,CAAGf,GAAG,CAAC,MAAI,CAAC4B,OAAN,YAAmBQ,KAAnB,cAA6BQ,QAAQ,CAACnC,KAAtC,eAAjB,CACA,GAAIM,KAAJ,CAAWL,aAAa,CAACsD,IAAd,CAAmB,OAAnB,EACX,GAAMC,CAAAA,SAAS,CAAG1D,aAAa,CAAC2D,eAAd,CAA8B,MAAI,CAAClB,QAAnC,CAA6CvC,KAA7C,CAAoDC,aAApD,CAAlB,CACA,GAAMyD,CAAAA,uBAAuB,CAAG,MAAI,CAACC,UAAL,CAAgBC,KAAhB,CAAsBC,EAAtB,CAA2BC,SAA3B,CAAuC,EAAvE,CAEA,mBACE,0BAAI,SAAS,CAAEN,SAAf,CAA0B,GAAG,WAAK1B,GAAL,aAAYK,QAAQ,CAACnC,KAArB,CAA7B,EACGqD,YAAY,CACX,MAAI,CAACvC,cADM,CAEXqB,QAFW,CAGXR,KAHW,CAIX,GAAIxC,CAAAA,QAAJ,CAAa,CACX4E,kBAAkB,CAAE,CAAEC,KAAK,CAAEN,uBAAT,CADT,CAEXR,QAAQ,CAAElB,MAAM,CAACG,QAAQ,CAACnC,KAAV,CAAN,CACNkC,aAAa,CAACC,QAAD,CADP,CAEN,SAAA8B,KAAK,0BAAIf,CAAAA,QAAQ,CAACvB,KAAD,CAAQsC,KAAR,SAAQA,KAAR,gCAAQA,KAAK,CAAEC,MAAf,wCAAQ,cAAeF,KAAvB,CAAZ,EAJE,CAKXnB,KAAK,CAAEO,UALI,CAMXN,qBAAqB,CAArBA,qBANW,CAOXC,kCAAkC,CAAlCA,kCAPW,CAQXC,YAAY,CAAZA,YARW,CASXC,YAAY,CAAZA,YATW,CAUXtB,KAAK,CAALA,KAVW,CAWXwB,eAAe,CAAfA,eAXW,CAAb,CAJW,CAiBX,GAAI/D,CAAAA,UAAJ,CAAe,CACba,aAAa,CAAE,EADF,CAEbkE,KAAK,CAAElF,IAFM,CAGbmF,KAAK,CAAE,MAHM,CAAf,CAjBW,CAAZ,EADH,CADF,CA2BD,CAjDA,CALH,cAuDE,0BAAI,SAAS,CAAC,aAAd,eACE,8BACE,IAAI,CAAC,QADP,CAEE,SAAS,CAAC,4BAFZ,CAGE,OAAO,CAAE,yBAAMnC,CAAAA,KAAK,EAAX,EAHX,EADF,CAvDF,cA8DE,0BAAI,SAAS,CAAC,cAAd,eACE,8BACE,IAAI,CAAC,QADP,CAEE,SAAS,CAAC,6BAFZ,CAGE,OAAO,CAAE,yBAAMJ,CAAAA,MAAM,EAAZ,EAHX,EADF,CA9DF,CADF,CAwED,C,4CAESH,iB,CAAmBK,M,CAAQH,G,CAAKI,M,CAAQ,iBAChD,GAAMqC,CAAAA,SAAS,CAAG,QAAZA,CAAAA,SAAY,CAAA1C,KAAK,QAAI,WAAM,CAC/B,GAAM2C,CAAAA,aAAa,CAAG3C,KAAK,GAAK,CAAV,EAAeI,MAAM,CAACM,MAAP,GAAkB,CAAvD,CACA,GAAIiC,aAAJ,CAAmB,CACjB,MAAI,CAACxD,cAAL,CAAoBM,GAApB,CAAwBmD,OAAxB,CAAgC,SAAApC,QAAQ,CAAI,CAC1C,GAAMqC,CAAAA,cAAc,CAAG,MAAI,CAACvD,WAAL,CAAiBkB,QAAQ,CAACnC,KAA1B,CAAvB,CACA,GAAM6C,CAAAA,KAAK,CACT2B,cAAc,EAAIA,cAAc,CAAC3B,KAAjC,CAAyC2B,cAAc,CAAC3B,KAAxD,CAAgEV,QAAQ,CAACnC,KAD3E,CAEA,GAAMyE,CAAAA,YAAY,WAAM,MAAI,CAAC3D,cAAL,CAAoBd,KAA1B,gBAAsC6C,KAAtC,CAAlB,CACA,GAAM6B,CAAAA,UAAU,CAAGvC,QAAQ,CAACwC,OAAT,CAAmBxC,QAAQ,CAACwC,OAAT,CAAiB,CAAjB,EAAoBX,KAAvC,CAA+C,EAAlE,CACA,GAAI,MAAI,CAACzB,QAAL,CAAcnC,QAAd,CAAuBqE,YAAvB,CAAJ,CAA0C,CACxC,MAAI,CAAClC,QAAL,CAAcG,QAAd,WAA0BlD,kBAAkB,CAACQ,KAA7C,EAAsD,EAAtD,EACA,MAAI,CAACuC,QAAL,CAAcG,QAAd,WAA0BjD,iBAAiB,CAACO,KAA5C,EAAqD,EAArD,EACA,MAAI,CAACuC,QAAL,CAAcG,QAAd,WAA0BhD,gBAAgB,CAACM,KAA3C,EAAoD,EAApD,EACA,MAAI,CAACuC,QAAL,CAAcG,QAAd,CAAuB+B,YAAvB,CAAqCC,UAArC,EACD,CACF,CAZD,EAaD,CAdD,IAcO,CACL3C,MAAM,CAACJ,KAAD,CAAN,CAAcE,MAAd,GACA,GAAM+C,CAAAA,cAAc,CAAG/E,GAAG,CAAC,MAAI,CAACgF,eAAN,WAA0B,MAAI,CAAC/D,cAAL,CAAoBd,KAA9C,aAAuD2B,KAAvD,EAA1B,CACA,MAAI,CAACgC,UAAL,CAAgBmB,QAAhB,CAAyBF,cAAzB,EAHK,GAIG1B,CAAAA,QAJH,CAIgB,MAAI,CAAClC,SAJrB,CAIGkC,QAJH,CAKL,GAAIA,QAAJ,CAAcA,QAAQ,CAACvB,KAAD,CAAQ,IAAR,CAAR,CACf,CACF,CAvBsB,EAAvB,CAyBA,MAAOI,CAAAA,MAAM,CAACV,GAAP,CAAW,SAACrB,KAAD,CAAQ2B,KAAR,CAAkB,CAClC,MAAO,CAAA,MAAI,CAACoD,SAAL,CACLrD,iBADK,CAELC,KAFK,CAGLC,GAHK,CAILyC,SAAS,CAAC1C,KAAD,CAJJ,CAKL3B,KAAK,CAAC8B,GALD,CAMLC,MANK,CAOLC,MAPK,CAAP,CASD,CAVM,CAAP,CAWD,C,8DAEkBN,iB,CAAmBsD,Y,CAAc,iBAClD,GAAIhD,CAAAA,MAAM,CAAG,EAAb,CACAiD,MAAM,CAACC,OAAP,CAAexD,iBAAf,EAAkC6C,OAAlC,CAA0C,eAAkB,mCAAhBzC,GAAgB,UAAXkC,KAAW,UAC1D,GAAIA,KAAK,CAACmB,YAAV,CAAwB,CACtBnD,MAAM,CAACF,GAAD,CAAN,CAAckC,KAAK,CAACmB,YAApB,CACD,CACF,CAJD,EAKA,mBACE,oBAAC,UAAD,EAAY,KAAK,CAAE,KAAKrE,cAAL,CAAoBd,KAAvC,EACG,mBAAG4B,CAAAA,GAAH,OAAGA,GAAH,CAAQG,MAAR,OAAQA,MAAR,oBACC,oBAAC,KAAD,CAAO,QAAP,mBACE,iCAAQ,MAAI,CAACqD,SAAL,CAAe1D,iBAAf,CAAkCK,MAAlC,CAA0CH,GAA1C,CAA+CI,MAA/C,CAAR,CADF,CAEG,MAAI,CAACqD,iBAAL,CAAuBL,YAAvB,CAAqCjD,MAArC,CAA6CH,GAA7C,CAAkD,MAAI,CAACd,cAAL,CAAoBd,KAAtE,CAA6EgC,MAA7E,CAFH,CADD,EADH,CADF,CAUD,C,4DAEiBgD,Y,CAAcjD,M,CAAQH,G,CAAKE,G,CAAKwD,K,CAAO,iBACvD,GAAMC,CAAAA,mBAAmB,CAAG,QAAtBA,CAAAA,mBAAsB,EAAM,2BAChC,GAAMC,CAAAA,MAAM,CAAG,EAAf,CACA,GAAIC,CAAAA,UAAU,CAAG,CAAjB,CACA,GAAMC,CAAAA,aAAa,CAAG,QAAhBA,CAAAA,aAAgB,CAACC,OAAD,CAAUC,KAAV,CAAiBjE,KAAjB,qBACpB,0BACE,GAAG,iBAAWG,GAAX,aAAkBH,KAAlB,CADL,CAEE,OAAO,CAAEgE,OAFX,CAGE,KAAK,CAAEzG,KAHT,CAIE,SAAS,CAAE,MAAI,CAAC6B,OAAL,CAAa8E,YAJ1B,EAMGD,KANH,CADoB,EAAtB,CAWA,GAAME,CAAAA,MAAM,oBAAOd,YAAY,CAACc,MAApB,CAAZ,CACA,GAAMC,CAAAA,UAAU,wBAAGf,YAAY,CAACjB,kBAAhB,gDAAG,sBAAiCC,KAApD,CAEA,MAAI,CAAClD,cAAL,CAAoBM,GAApB,CAAwBmD,OAAxB,CAAgC,SAACjD,EAAD,CAAKK,KAAL,CAAe,CAC7C,GAAIA,KAAK,CAAG,CAAZ,CAAe,OACf,GAAI2D,KAAK,CAAChE,EAAE,CAACtB,KAAJ,CAAT,CAAqB,CACnB,GAAIyF,UAAU,CAAG,CAAjB,CAAoB,CAClBD,MAAM,CAACjC,IAAP,CAAYmC,aAAa,CAACD,UAAD,CAAaK,MAAM,CAACE,KAAP,EAAb,CAA6BrE,KAA7B,CAAzB,EACA8D,UAAU,CAAG,CAAb,CACD,CACDD,MAAM,CAACjC,IAAP,cACE,0BAAI,GAAG,iBAAWzB,GAAX,aAAkBH,KAAlB,CAAP,EACG2D,KAAK,CAAChE,EAAE,CAACtB,KAAJ,CAAL,CAAgBsD,KAAhB,CACCgC,KAAK,CAAChE,EAAE,CAACtB,KAAJ,CAAL,CAAgBwC,MADjB,CAEC,GAAIrD,CAAAA,QAAJ,CAAa,CACX4E,kBAAkB,CAAE,CAClBC,KAAK,CAAEzE,GAAG,CAACwG,UAAD,gBAAqBzG,UAAU,CAACgC,EAAE,CAACtB,KAAJ,CAA/B,EADQ,CADT,CAAb,CAFD,CADH,CADF,EAYD,CAjBD,IAiBO,CACLyF,UAAU,GACX,CACF,CAtBD,EAuBA,GAAIA,UAAU,CAAG,CAAjB,CAAoB,CAClBD,MAAM,CAACjC,IAAP,CAAYmC,aAAa,CAACD,UAAD,CAAzB,EACAA,UAAU,CAAG,CAAb,CACD,CACD,MAAOD,CAAAA,MAAP,CACD,CA7CD,CA8CA,mBACE,6BAAO,GAAG,CAAE1D,GAAZ,eACE,2CACE,0BAAI,SAAS,CAAC,WAAd,CAA0B,OAAO,CAAC,GAAlC,eACE,8BAAQ,IAAI,CAAC,QAAb,CAAsB,SAAS,CAAC,oBAAhC,CAAqD,OAAO,CAAE,yBAAMF,CAAAA,GAAG,EAAT,EAA9D,0FADF,CADF,CAMG2D,mBAAmB,EANtB,cAOE,0BAAI,SAAS,CAAC,WAAd,CAA0B,OAAO,CAAC,GAAlC,EAPF,CADF,CADF,CAaD,C,sCACM7D,iB,CAAmBsD,Y,CAAciB,e,CAAiBC,S,CAAWC,O,CAASC,S,CAAW,iBACtF,KAAKC,UAAL,CAAkBH,SAAlB,CACA,KAAK3D,QAAL,CAAgB4D,OAAhB,CACA,KAAKxC,UAAL,CAAkByC,SAAlB,CACA,KAAKvB,eAAL,CAAuBuB,SAAS,CAACE,KAAjC,CACA,KAAK/E,OAAL,CAAe,EAAf,CACA0D,MAAM,CAACsB,IAAP,CAAYN,eAAZ,EAA6B1B,OAA7B,CACE,SAAAvE,KAAK,QAAK,CAAA,MAAI,CAACuB,OAAL,CAAavB,KAAb,EAAsBiG,eAAe,CAACjG,KAAD,CAAf,CAAuBoE,KAAlD,EADP,EAIA,GAAMoC,CAAAA,iBAAiB,CAAG,KAAKjE,QAAL,CAAcrC,QAAd,CAAuB,KAAKY,cAAL,CAAoBd,KAA3C,CAA1B,CACA,mBACE,oBAAC,KAAD,CAAO,QAAP,mBACE,8BADF,CAEGwG,iBAAiB,eAChB,6BAAO,SAAS,CAAC,2CAAjB,4OAHJ,cAOE,6BAAO,SAAS,CAAC,cAAjB,EACG,KAAKC,eAAL,EADH,CAEG,KAAKC,kBAAL,CAAwBhF,iBAAxB,CAA2CsD,YAA3C,CAFH,CAPF,CADF,CAcD,C,6BAIH,cAAelF,CAAAA,aAAf","sourcesContent":["import React from 'react';\r\nimport { ArrayField } from 'informed';\r\nimport { LEFT, RIGHT } from '../../Placement';\r\nimport Behavior from '../parameters/Behavior';\r\nimport Appearance from '../parameters/Appearance';\r\nimport classNames from 'classnames';\r\nimport { capitalize } from '../../../utils/StringUtil';\r\nimport get from 'get-value';\r\nimport TotalCostBeforeTax from '@distate/core/dist/domain/documents/upd/vo/total/TotalCostBeforeTax';\r\nimport TotalCostAfterTax from '@distate/core/dist/domain/documents/upd/vo/total/TotalCostAfterTax';\r\nimport TotalAmountOfTax from '@distate/core/dist/domain/documents/upd/vo/total/TotalAmountOfTax';\r\nimport { format as formatMoney } from '../../../utils/MoneyUtil';\r\nimport { del } from 'object-path-immutable';\r\n\r\nclass DocumentTable {\r\n  static createTDClasses(formApi = null, field = '', customClasses = ['input']) {\r\n    if (!formApi) return classNames(customClasses);\r\n    const { getError, getTouched, getValue } = formApi;\r\n    const res = {};\r\n    if (field) {\r\n      res.error = getError(field);\r\n      res.success = !getError(field) && getTouched(field) && getValue(field);\r\n    }\r\n    return classNames(res, customClasses);\r\n  }\r\n\r\n  constructor(GroupDomainVO, styles, behavior, behaviours, appearances, errors) {\r\n    this._groupDomainVO = GroupDomainVO;\r\n    this._styles = styles;\r\n    this._behavior = behavior;\r\n    this._behaviours = behaviours;\r\n    this._appearances = appearances;\r\n    this._errors = errors;\r\n  }\r\n\r\n  createTableHead() {\r\n    return (\r\n      <React.Fragment>\r\n        <colgroup>\r\n          <col></col>\r\n          {this._groupDomainVO.VOs.map(vo => {\r\n            if (this._widths[vo.field]) {\r\n              return <col width={this._widths[vo.field]} key={`${vo.field}`}></col>;\r\n            } else {\r\n              return <col key={`${vo.field}`}></col>;\r\n            }\r\n          })}\r\n        </colgroup>\r\n        <thead>\r\n          <tr>\r\n            <th>№</th>\r\n            {this._groupDomainVO.VOs.map(vo => {\r\n              const noCaption = get(this._appearances[vo.field], 'noCaption');\r\n              return <th key={`${vo.field}`}>{!noCaption && vo.name}</th>;\r\n            })}\r\n            <th colSpan=\"2\"></th>\r\n          </tr>\r\n        </thead>\r\n      </React.Fragment>\r\n    );\r\n  }\r\n\r\n  createRow(createElementsMap, index, add, remove, key, fields, totals = {}) {\r\n    const clone = () => {\r\n      // TODO реализовать клонирование ячейки\r\n      add();\r\n    };\r\n    const onTotalChange = DomainVO => () => {\r\n      let aggregatedResult;\r\n      if (fields.length) {\r\n        const values = fields.map(({ field }) => {\r\n          return this._formAPI.getValue(`${field}.${DomainVO.field}`);\r\n        });\r\n        aggregatedResult = formatMoney(totals[DomainVO.field].domain.calculate(...values));\r\n        this._formAPI.setValue(totals[DomainVO.field].domain.field, aggregatedResult);\r\n      }\r\n    };\r\n    return (\r\n      <tr className=\"tr-good\" key={key}>\r\n        <td className={this._styles.center}>\r\n          <span>{index + 1}</span>\r\n        </td>\r\n        {/* this._groupDomainVO.VOs - массив функций-конструкторов */}\r\n        {this._groupDomainVO.VOs.map(DomainVO => {\r\n          if (!createElementsMap[DomainVO.field]) {\r\n            throw new Error(`Забыли задать конфигурацию для поля ${DomainVO.field} в таблице`);\r\n          }\r\n          const {\r\n            scope,\r\n            dataAttributeSelector,\r\n            componentStateAdditionalDataConfig,\r\n            modalBuilder,\r\n            showErrorMsg,\r\n            onChange = () => {},\r\n            customFieldName\r\n          } = this._behaviours[DomainVO.field] || {};\r\n          const fieldScope = scope || DomainVO.field;\r\n          const field = `${this._groupDomainVO.field}[${index}].${fieldScope}`;\r\n          const inputBuilder = createElementsMap[DomainVO.field].build;\r\n          const customClasses = ['input'];\r\n          const error = get(this._errors, `[${index}].${DomainVO.field}.errors[0]`);\r\n          if (error) customClasses.push('error');\r\n          const tdClasses = DocumentTable.createTDClasses(this._formAPI, field, customClasses);\r\n          const initialFieldDomainValue = this._component.props.id ? undefined : '';\r\n\r\n          return (\r\n            <td className={tdClasses} key={`${key}_${DomainVO.field}`}>\r\n              {inputBuilder(\r\n                this._groupDomainVO,\r\n                DomainVO,\r\n                index,\r\n                new Behavior({\r\n                  initialFieldDomain: { value: initialFieldDomainValue },\r\n                  onChange: totals[DomainVO.field]\r\n                    ? onTotalChange(DomainVO)\r\n                    : event => onChange(index, event?.target?.value),\r\n                  scope: fieldScope,\r\n                  dataAttributeSelector,\r\n                  componentStateAdditionalDataConfig,\r\n                  modalBuilder,\r\n                  showErrorMsg,\r\n                  index,\r\n                  customFieldName\r\n                }),\r\n                new Appearance({\r\n                  customClasses: '',\r\n                  align: LEFT,\r\n                  width: 'auto'\r\n                })\r\n              )()}\r\n            </td>\r\n          );\r\n        })}\r\n        <td className=\"table-clone\">\r\n          <button\r\n            type=\"button\"\r\n            className=\"ds-button icon-clone solid\"\r\n            onClick={() => clone()}\r\n          ></button>\r\n        </td>\r\n        <td className=\"table-remove\">\r\n          <button\r\n            type=\"button\"\r\n            className=\"ds-button icon-delete solid\"\r\n            onClick={() => remove()}\r\n          ></button>\r\n        </td>\r\n      </tr>\r\n    );\r\n  }\r\n\r\n  groupRows(createElementsMap, fields, add, totals) {\r\n    const removeRow = index => () => {\r\n      const isLastRowLeft = index === 0 && fields.length === 1;\r\n      if (isLastRowLeft) {\r\n        this._groupDomainVO.VOs.forEach(DomainVO => {\r\n          const fieldBehaviour = this._behaviours[DomainVO.field];\r\n          const scope =\r\n            fieldBehaviour && fieldBehaviour.scope ? fieldBehaviour.scope : DomainVO.field;\r\n          const fieldToClear = `${this._groupDomainVO.field}[0].${scope}`;\r\n          const blankValue = DomainVO.options ? DomainVO.options[0].value : '';\r\n          if (this._formAPI.getValue(fieldToClear)) {\r\n            this._formAPI.setValue(`${TotalCostBeforeTax.field}`, '');\r\n            this._formAPI.setValue(`${TotalCostAfterTax.field}`, '');\r\n            this._formAPI.setValue(`${TotalAmountOfTax.field}`, '');\r\n            this._formAPI.setValue(fieldToClear, blankValue);\r\n          }\r\n        });\r\n      } else {\r\n        fields[index].remove();\r\n        const componentState = del(this._componentState, `${this._groupDomainVO.field}.${index}`);\r\n        this._component.setState(componentState);\r\n        const { onChange } = this._behavior;\r\n        if (onChange) onChange(index, true);\r\n      }\r\n    };\r\n\r\n    return fields.map((field, index) => {\r\n      return this.createRow(\r\n        createElementsMap,\r\n        index,\r\n        add,\r\n        removeRow(index),\r\n        field.key,\r\n        fields,\r\n        totals\r\n      );\r\n    });\r\n  }\r\n\r\n  createTableContent(createElementsMap, footerConfig) {\r\n    let totals = {};\r\n    Object.entries(createElementsMap).forEach(([key, value]) => {\r\n      if (value.aggregatedBy) {\r\n        totals[key] = value.aggregatedBy;\r\n      }\r\n    });\r\n    return (\r\n      <ArrayField field={this._groupDomainVO.field}>\r\n        {({ add, fields }) => (\r\n          <React.Fragment>\r\n            <tbody>{this.groupRows(createElementsMap, fields, add, totals)}</tbody>\r\n            {this.createTableFooter(footerConfig, fields, add, this._groupDomainVO.field, totals)}\r\n          </React.Fragment>\r\n        )}\r\n      </ArrayField>\r\n    );\r\n  }\r\n\r\n  createTableFooter(footerConfig, fields, add, key, total) {\r\n    const createFooterColumns = () => {\r\n      const result = [];\r\n      let colspanAcc = 0;\r\n      const createEmptyTd = (colspan, label, index) => (\r\n        <td\r\n          key={`empty_${key}_${index}`}\r\n          colSpan={colspan}\r\n          align={RIGHT}\r\n          className={this._styles.paddingRight}\r\n        >\r\n          {label}\r\n        </td>\r\n      );\r\n\r\n      const labels = [...footerConfig.labels];\r\n      const initValues = footerConfig.initialFieldDomain?.value;\r\n\r\n      this._groupDomainVO.VOs.forEach((vo, index) => {\r\n        if (index < 1) return;\r\n        if (total[vo.field]) {\r\n          if (colspanAcc > 0) {\r\n            result.push(createEmptyTd(colspanAcc, labels.shift(), index));\r\n            colspanAcc = 0;\r\n          }\r\n          result.push(\r\n            <td key={`total_${key}_${index}`}>\r\n              {total[vo.field].build(\r\n                total[vo.field].domain,\r\n                new Behavior({\r\n                  initialFieldDomain: {\r\n                    value: get(initValues, `total${capitalize(vo.field)}`)\r\n                  }\r\n                })\r\n              )}\r\n            </td>\r\n          );\r\n        } else {\r\n          colspanAcc++;\r\n        }\r\n      });\r\n      if (colspanAcc > 0) {\r\n        result.push(createEmptyTd(colspanAcc));\r\n        colspanAcc = 0;\r\n      }\r\n      return result;\r\n    };\r\n    return (\r\n      <tfoot key={key}>\r\n        <tr>\r\n          <td className=\"table-add\" colSpan=\"2\">\r\n            <button type=\"button\" className=\"ds-button icon-add\" onClick={() => add()}>\r\n              Добавить запись\r\n            </button>\r\n          </td>\r\n          {createFooterColumns()}\r\n          <td className=\"table-add\" colSpan=\"2\"></td>\r\n        </tr>\r\n      </tfoot>\r\n    );\r\n  }\r\n  create(createElementsMap, footerConfig, tableAppearance, formState, formAPI, component) {\r\n    this._formState = formState;\r\n    this._formAPI = formAPI;\r\n    this._component = component;\r\n    this._componentState = component.state;\r\n    this._widths = {};\r\n    Object.keys(tableAppearance).forEach(\r\n      field => (this._widths[field] = tableAppearance[field].width)\r\n    );\r\n\r\n    const showTableErrorMsg = this._formAPI.getError(this._groupDomainVO.field);\r\n    return (\r\n      <React.Fragment>\r\n        <br />\r\n        {showTableErrorMsg && (\r\n          <label className=\"ds-field-name top color-danger width-auto\">\r\n            Проверьте правильность заполнения таблицы\r\n          </label>\r\n        )}\r\n        <table className=\"table-editor\">\r\n          {this.createTableHead()}\r\n          {this.createTableContent(createElementsMap, footerConfig)}\r\n        </table>\r\n      </React.Fragment>\r\n    );\r\n  }\r\n}\r\n\r\n\r\nexport default DocumentTable;\r\n"]},"metadata":{},"sourceType":"module"}