{"ast":null,"code":"import _slicedToArray from\"C:\\\\Users\\\\Hovsep\\\\Desktop\\\\local\\\\diflow_react\\\\node_modules\\\\babel-preset-react-app\\\\node_modules\\\\@babel\\\\runtime/helpers/esm/slicedToArray\";import _defineProperty from\"C:\\\\Users\\\\Hovsep\\\\Desktop\\\\local\\\\diflow_react\\\\node_modules\\\\babel-preset-react-app\\\\node_modules\\\\@babel\\\\runtime/helpers/esm/defineProperty\";import _classCallCheck from\"C:\\\\Users\\\\Hovsep\\\\Desktop\\\\local\\\\diflow_react\\\\node_modules\\\\babel-preset-react-app\\\\node_modules\\\\@babel\\\\runtime/helpers/esm/classCallCheck\";import _createClass from\"C:\\\\Users\\\\Hovsep\\\\Desktop\\\\local\\\\diflow_react\\\\node_modules\\\\babel-preset-react-app\\\\node_modules\\\\@babel\\\\runtime/helpers/esm/createClass\";import _inherits from\"C:\\\\Users\\\\Hovsep\\\\Desktop\\\\local\\\\diflow_react\\\\node_modules\\\\babel-preset-react-app\\\\node_modules\\\\@babel\\\\runtime/helpers/esm/inherits\";import _createSuper from\"C:\\\\Users\\\\Hovsep\\\\Desktop\\\\local\\\\diflow_react\\\\node_modules\\\\babel-preset-react-app\\\\node_modules\\\\@babel\\\\runtime/helpers/esm/createSuper\";import _applyDecoratedDescriptor from\"C:\\\\Users\\\\Hovsep\\\\Desktop\\\\local\\\\diflow_react\\\\node_modules\\\\babel-preset-react-app\\\\node_modules\\\\@babel\\\\runtime/helpers/esm/applyDecoratedDescriptor\";var _class;import FormBuilderBase from'./FormBuilderBase';import React from'react';import{Form,Text}from'informed';import Button,{PRIMARY}from'../Button';import{ICON}from'@distate/components';import Autocomplete from'../autocomplete/Autocomplete';import styles from'./FormBuilder.module.css';import FormBase from'./FormBase';import autobind from'autobind-decorator';import classNames from'classnames';import{capitalize}from'../../utils/StringUtil';import AutocompleteService from'@distate/core/dist/application/autocomplete/AutocompleteService';import{LEFT}from'../Placement';import deepmerge from'deepmerge';import get from'get-value';import{Loading}from'@distate/components';var FormBuilder=(_class=/*#__PURE__*/function(_FormBuilderBase){_inherits(FormBuilder,_FormBuilderBase);var _super=_createSuper(FormBuilder);_createClass(FormBuilder,null,[{key:\"createInputClasses\",value:function createInputClasses(formState,field){var errors=formState.errors,values=formState.values,touched=formState.touched;return classNames({'ds-input':true,error:errors[field],success:!errors[field]&&touched[field]&&values[field]});}}]);function FormBuilder(component){var _this;_classCallCheck(this,FormBuilder);_this=_super.call(this);if(!(component instanceof FormBase)){throw new Error('Параметр должен быть экземпляром класса FormBase');}_this._createForm=function(){return null;};_this._content=[];_this._createLoader=function(){return null;};_this._createFooter=function(){return null;};_this._component=component;_this._requiredFields=[];return _this;}_createClass(FormBuilder,[{key:\"getLabel\",value:function getLabel(fieldName,isRequired,align){return/*#__PURE__*/React.createElement(\"p\",{className:\"ds-field-name \".concat(styles.verticalAlignTop)},fieldName,isRequired&&' *');}},{key:\"buildForm\",value:function buildForm(){var _this2=this;var requiredFields=arguments.length>0&&arguments[0]!==undefined?arguments[0]:[];if(requiredFields.length){this._requiredFields=requiredFields;}this._createForm=function(){return/*#__PURE__*/React.createElement(React.Fragment,null,_this2._createLoader(),/*#__PURE__*/React.createElement(\"ul\",{className:\"form\"},_this2._content.map(function(createElement){return createElement();})),_this2._createFooter());};return this._createForm;}},{key:\"buildInfo\",value:function buildInfo(DomainVO,fieldDomain){this._content.push(function(){return/*#__PURE__*/React.createElement(\"li\",null,/*#__PURE__*/React.createElement(\"p\",{className:\"ds-field-name\"},DomainVO.name),/*#__PURE__*/React.createElement(\"p\",{className:\"ds-field-value\"},fieldDomain.value));});}},{key:\"buildInput\",value:function buildInput(DomainVO){var _this3=this;var initialFieldDomain=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{value:''};var isRequired=arguments.length>2&&arguments[2]!==undefined?arguments[2]:false;var input=function input(){return/*#__PURE__*/React.createElement(\"li\",null,_this3.getLabel(DomainVO.name,isRequired),/*#__PURE__*/React.createElement(\"div\",{className:\"group\"},/*#__PURE__*/React.createElement(Text,{field:DomainVO.field,title:DomainVO.hint,initialValue:initialFieldDomain&&initialFieldDomain.value,className:FormBuilder.createInputClasses(_this3._formState,DomainVO.field),placeholder:DomainVO.placeholder,mask:DomainVO.mask,validate:DomainVO.validate,validateOnChange:true,validateOnBlur:true}),/*#__PURE__*/React.createElement(\"span\",{className:\"ds-field-name bottom error\"},_this3._formState.errors[DomainVO.field])));};this._content.push(input);}},{key:\"buildAutocomplete\",value:function buildAutocomplete(DomainVO){var _this4=this;var initialFieldDomain=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{value:''};var isRequired=arguments.length>2&&arguments[2]!==undefined?arguments[2]:false;var captionField=arguments.length>3&&arguments[3]!==undefined?arguments[3]:'';var width=arguments.length>4?arguments[4]:undefined;var align=arguments.length>5&&arguments[5]!==undefined?arguments[5]:LEFT;var serverErrorMsg=get(this._component.state.errors,DomainVO.field);if(isRequired){this._requiredFields.push(DomainVO.field);}var acService=AutocompleteService[DomainVO.field];var handleItemSelect=function handleItemSelect(ajaxResponseValues){return function(selectedValue){if(ajaxResponseValues){_this4._formApi.setValue(DomainVO.field,selectedValue);var selectedItem=ajaxResponseValues.rows.find(function(item){return item[acService.field]===selectedValue;});_this4._component.setState(_defineProperty({},DomainVO.field,selectedItem));}};};var handleAutocompleteValidate=function handleAutocompleteValidate(DomainField){return function(res){return function(inputValue){if(res===null){return undefined;}if(!inputValue){_this4._component.setState(_defineProperty({},DomainVO.field,''));return!isRequired?undefined:'Введите значение';}var filteredRes=res.filter(function(item){return item.toLowerCase().includes(inputValue.toLowerCase());});if(filteredRes.length===1){_this4._component.setState(_defineProperty({},DomainVO.field,inputValue));return undefined;}if(filteredRes.length>1||filteredRes.length===0){_this4._component.setState(_defineProperty({},DomainVO.field,inputValue));if(filteredRes.some(function(item){return item===inputValue;})){return undefined;}else{return'Выберите значение из выпадающего списка';}}// comment for merging\nreturn undefined;};};};var autocompleteState=this._component.state[DomainVO.field];var caption=captionField&&autocompleteState&&autocompleteState[captionField]&&/*#__PURE__*/React.createElement(\"p\",{className:\"caption \".concat(styles.caption)},autocompleteState[captionField]);var autocomplete=function autocomplete(){var formStateErrorMsg=_this4._formState&&_this4._formState.errors[DomainVO.field];var errorMsg=typeof serverErrorMsg==='string'&&serverErrorMsg||typeof formStateErrorMsg==='string'&&formStateErrorMsg;return/*#__PURE__*/React.createElement(\"li\",null,_this4.getLabel(DomainVO.name,isRequired,align),/*#__PURE__*/React.createElement(\"div\",{className:\"group\"},/*#__PURE__*/React.createElement(Autocomplete,{doAjax:acService.request,formatAjaxRes:function formatAjaxRes(res){return res.rows.map(function(row){return row[acService.field];});},handleItemSelect:handleItemSelect,handleAutocompleteValidate:handleAutocompleteValidate(DomainVO.field)},/*#__PURE__*/React.createElement(Text,{field:DomainVO.field,title:DomainVO.hint,initialValue:initialFieldDomain&&initialFieldDomain.value,className:FormBuilder.createInputClasses(_this4._formState,DomainVO.field),style:{width:width},placeholder:DomainVO.placeholder,mask:DomainVO.mask,validateOnChange:true,validateOnBlur:true})),/*#__PURE__*/React.createElement(\"span\",{className:\"ds-field-name bottom error\"},errorMsg),!errorMsg&&caption));};this._content.push(autocomplete);return autocomplete;}},{key:\"buildLoader\",value:function buildLoader(){var _this5=this;this._createLoader=function(){return _this5._component.state.isBusy&&/*#__PURE__*/React.createElement(Loading,{isRelative:false});};return this._createLoader;}},{key:\"buildSubmit\",value:function buildSubmit(lbl){var _this6=this;var submitCallback=arguments.length>1&&arguments[1]!==undefined?arguments[1]:null;var handleErrorCb=arguments.length>2&&arguments[2]!==undefined?arguments[2]:null;var submitHandler=submitCallback;var _handleError=handleErrorCb;if(!submitHandler){submitHandler=function submitHandler(submitCb){return function(){_this6._component.checkCompleteness(_this6._formState,_this6._requiredFields);if(!_handleError){_handleError=function handleError(field,value){if(typeof value==='object'){Object.entries(value).forEach(function(_ref){var _ref2=_slicedToArray(_ref,2),key=_ref2[0],value=_ref2[1];return _handleError(key,value[0]);});return;}if(isNaN(+field)&&field!=='status'){_this6._formApi.setError(field,capitalize(value));}};}var combineMerge=function combineMerge(target,source,options){var destination=target.slice();source.forEach(function(item,index){if(typeof destination[index]==='undefined'){destination[index]=options.cloneUnlessOtherwiseSpecified(item,options);}else if(options.isMergeableObject(item)){destination[index]=deepmerge(target[index],item,options);}else if(target.indexOf(item)===-1){destination.push(item);}});return destination;};submitCb(deepmerge(_this6._formState.values,_this6._component.state,{arrayMerge:combineMerge}),_handleError);};};}this._createFooter=function(){return/*#__PURE__*/React.createElement(\"div\",{className:\"ds-toolbar-wrapper\"},/*#__PURE__*/React.createElement(\"div\",{className:\"ds-toolbar\"},/*#__PURE__*/React.createElement(Button,{colorClass:PRIMARY,iconClass:ICON.accept,onClick:submitHandler(_this6._component.submit)},lbl)));};}},{key:\"onChange\",value:function onChange(){this._component.checkCompleteness(this._formState,this._requiredFields);}},{key:\"getForm\",value:function getForm(){var _this7=this;return/*#__PURE__*/React.createElement(Form,{onChange:this.onChange},function(_ref3){var formState=_ref3.formState,formApi=_ref3.formApi;_this7._formApi=formApi;_this7._formState=formState;return _this7._createForm();});}},{key:\"formApi\",get:function get(){return this._formApi;}},{key:\"formState\",get:function get(){return this._formState;}},{key:\"content\",get:function get(){return this._content;}},{key:\"component\",get:function get(){return this._component;}}]);return FormBuilder;}(FormBuilderBase),(_applyDecoratedDescriptor(_class.prototype,\"onChange\",[autobind],Object.getOwnPropertyDescriptor(_class.prototype,\"onChange\"),_class.prototype)),_class);export default FormBuilder;","map":{"version":3,"sources":["C:/Users/Hovsep/Desktop/local/diflow_react/packages/app/src/common/form/FormBuilder.js"],"names":["FormBuilderBase","React","Form","Text","Button","PRIMARY","ICON","Autocomplete","styles","FormBase","autobind","classNames","capitalize","AutocompleteService","LEFT","deepmerge","get","Loading","FormBuilder","formState","field","errors","values","touched","error","success","component","Error","_createForm","_content","_createLoader","_createFooter","_component","_requiredFields","fieldName","isRequired","align","verticalAlignTop","requiredFields","length","map","createElement","DomainVO","fieldDomain","push","name","value","initialFieldDomain","input","getLabel","hint","createInputClasses","_formState","placeholder","mask","validate","captionField","width","serverErrorMsg","state","acService","handleItemSelect","ajaxResponseValues","selectedValue","_formApi","setValue","selectedItem","rows","find","item","setState","handleAutocompleteValidate","DomainField","res","inputValue","undefined","filteredRes","filter","toLowerCase","includes","some","autocompleteState","caption","autocomplete","formStateErrorMsg","errorMsg","request","row","isBusy","lbl","submitCallback","handleErrorCb","submitHandler","handleError","submitCb","checkCompleteness","Object","entries","forEach","key","isNaN","setError","combineMerge","target","source","options","destination","slice","index","cloneUnlessOtherwiseSpecified","isMergeableObject","indexOf","arrayMerge","accept","submit","onChange","formApi"],"mappings":"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","sourcesContent":["import FormBuilderBase from './FormBuilderBase';\r\nimport React from 'react';\r\nimport { Form, Text } from 'informed';\r\nimport Button, { PRIMARY } from '../Button';\r\nimport { ICON } from '@distate/components';\r\nimport Autocomplete from '../autocomplete/Autocomplete';\r\nimport styles from './FormBuilder.module.css';\r\nimport FormBase from './FormBase';\r\nimport autobind from 'autobind-decorator';\r\nimport classNames from 'classnames';\r\nimport { capitalize } from '../../utils/StringUtil';\r\nimport AutocompleteService from '@distate/core/dist/application/autocomplete/AutocompleteService';\r\nimport { LEFT } from '../Placement';\r\nimport deepmerge from 'deepmerge';\r\nimport get from 'get-value';\r\nimport { Loading } from '@distate/components';\r\n\r\nclass FormBuilder extends FormBuilderBase {\r\n  static createInputClasses(formState, field) {\r\n    const { errors, values, touched } = formState;\r\n    return classNames({\r\n      'ds-input': true,\r\n      error: errors[field],\r\n      success: !errors[field] && touched[field] && values[field]\r\n    });\r\n  }\r\n\r\n  constructor(component) {\r\n    super();\r\n    if (!(component instanceof FormBase)) {\r\n      throw new Error('Параметр должен быть экземпляром класса FormBase');\r\n    }\r\n    this._createForm = () => null;\r\n    this._content = [];\r\n    this._createLoader = () => null;\r\n    this._createFooter = () => null;\r\n    this._component = component;\r\n    this._requiredFields = [];\r\n  }\r\n\r\n  getLabel(fieldName, isRequired, align) {\r\n    return (\r\n      <p className={`ds-field-name ${styles.verticalAlignTop}`}>\r\n        {fieldName}\r\n        {isRequired && ' *'}\r\n      </p>\r\n    );\r\n  }\r\n\r\n  buildForm(requiredFields = []) {\r\n    if (requiredFields.length) {\r\n      this._requiredFields = requiredFields;\r\n    }\r\n    this._createForm = () => (\r\n      <React.Fragment>\r\n        {this._createLoader()}\r\n        <ul className=\"form\">{this._content.map(createElement => createElement())}</ul>\r\n        {this._createFooter()}\r\n      </React.Fragment>\r\n    );\r\n    return this._createForm;\r\n  }\r\n\r\n  buildInfo(DomainVO, fieldDomain) {\r\n    this._content.push(() => (\r\n      <li>\r\n        <p className=\"ds-field-name\">{DomainVO.name}</p>\r\n        <p className=\"ds-field-value\">{fieldDomain.value}</p>\r\n      </li>\r\n    ));\r\n  }\r\n\r\n  buildInput(DomainVO, initialFieldDomain = { value: '' }, isRequired = false) {\r\n    const input = () => (\r\n      <li>\r\n        {this.getLabel(DomainVO.name, isRequired)}\r\n        <div className=\"group\">\r\n          <Text\r\n            field={DomainVO.field}\r\n            title={DomainVO.hint}\r\n            initialValue={initialFieldDomain && initialFieldDomain.value}\r\n            className={FormBuilder.createInputClasses(this._formState, DomainVO.field)}\r\n            placeholder={DomainVO.placeholder}\r\n            mask={DomainVO.mask}\r\n            validate={DomainVO.validate}\r\n            validateOnChange\r\n            validateOnBlur\r\n          />\r\n          <span className=\"ds-field-name bottom error\">\r\n            {this._formState.errors[DomainVO.field]}\r\n          </span>\r\n        </div>\r\n      </li>\r\n    );\r\n\r\n    this._content.push(input);\r\n  }\r\n\r\n  buildAutocomplete(\r\n    DomainVO,\r\n    initialFieldDomain = { value: '' },\r\n    isRequired = false,\r\n    captionField = '',\r\n    width,\r\n    align = LEFT\r\n  ) {\r\n    const serverErrorMsg = get(this._component.state.errors, DomainVO.field);\r\n\r\n    if (isRequired) {\r\n      this._requiredFields.push(DomainVO.field);\r\n    }\r\n    const acService = AutocompleteService[DomainVO.field];\r\n    const handleItemSelect = ajaxResponseValues => selectedValue => {\r\n      if (ajaxResponseValues) {\r\n        this._formApi.setValue(DomainVO.field, selectedValue);\r\n        const selectedItem = ajaxResponseValues.rows.find(\r\n          item => item[acService.field] === selectedValue\r\n        );\r\n\r\n        this._component.setState({ [DomainVO.field]: selectedItem });\r\n      }\r\n    };\r\n\r\n    const handleAutocompleteValidate = DomainField => res => inputValue => {\r\n      if (res === null) {\r\n        return undefined;\r\n      }\r\n\r\n      if (!inputValue) {\r\n        this._component.setState({ [DomainVO.field]: '' });\r\n        return !isRequired ? undefined : 'Введите значение';\r\n      }\r\n\r\n      const filteredRes = res.filter(item => {\r\n        return item.toLowerCase().includes(inputValue.toLowerCase());\r\n      });\r\n\r\n      if (filteredRes.length === 1) {\r\n        this._component.setState({ [DomainVO.field]: inputValue });\r\n        return undefined;\r\n      }\r\n\r\n      if (filteredRes.length > 1 || filteredRes.length === 0) {\r\n        this._component.setState({ [DomainVO.field]: inputValue });\r\n\r\n        if (filteredRes.some(item => item === inputValue)) {\r\n          return undefined;\r\n        } else {\r\n          return 'Выберите значение из выпадающего списка';\r\n        }\r\n      }\r\n      // comment for merging\r\n      return undefined;\r\n    };\r\n\r\n    const autocompleteState = this._component.state[DomainVO.field];\r\n\r\n    const caption = captionField && autocompleteState && autocompleteState[captionField] && (\r\n      <p className={`caption ${styles.caption}`}>{autocompleteState[captionField]}</p>\r\n    );\r\n\r\n    const autocomplete = () => {\r\n      const formStateErrorMsg = this._formState && this._formState.errors[DomainVO.field];\r\n      const errorMsg =\r\n        (typeof serverErrorMsg === 'string' && serverErrorMsg) ||\r\n        (typeof formStateErrorMsg === 'string' && formStateErrorMsg);\r\n      return (\r\n        <li>\r\n          {this.getLabel(DomainVO.name, isRequired, align)}\r\n          <div className=\"group\">\r\n            <Autocomplete\r\n              doAjax={acService.request}\r\n              formatAjaxRes={res => res.rows.map(row => row[acService.field])}\r\n              handleItemSelect={handleItemSelect}\r\n              handleAutocompleteValidate={handleAutocompleteValidate(DomainVO.field)}\r\n            >\r\n              <Text\r\n                field={DomainVO.field}\r\n                title={DomainVO.hint}\r\n                initialValue={initialFieldDomain && initialFieldDomain.value}\r\n                className={FormBuilder.createInputClasses(this._formState, DomainVO.field)}\r\n                style={{ width }}\r\n                placeholder={DomainVO.placeholder}\r\n                mask={DomainVO.mask}\r\n                validateOnChange\r\n                validateOnBlur\r\n              />\r\n            </Autocomplete>\r\n            <span className=\"ds-field-name bottom error\">{errorMsg}</span>\r\n\r\n            {!errorMsg && caption}\r\n          </div>\r\n        </li>\r\n      );\r\n    };\r\n    this._content.push(autocomplete);\r\n    return autocomplete;\r\n  }\r\n\r\n  buildLoader() {\r\n    this._createLoader = () => this._component.state.isBusy && <Loading isRelative={false} />;\r\n\r\n    return this._createLoader;\r\n  }\r\n\r\n  buildSubmit(lbl, submitCallback = null, handleErrorCb = null) {\r\n    let submitHandler = submitCallback;\r\n    let handleError = handleErrorCb;\r\n\r\n    if (!submitHandler) {\r\n      submitHandler = submitCb => () => {\r\n        this._component.checkCompleteness(this._formState, this._requiredFields);\r\n\r\n        if (!handleError) {\r\n          handleError = (field, value) => {\r\n            if (typeof value === 'object') {\r\n              Object.entries(value).forEach(([key, value]) => handleError(key, value[0]));\r\n              return;\r\n            }\r\n            if (isNaN(+field) && field !== 'status') {\r\n              this._formApi.setError(field, capitalize(value));\r\n            }\r\n          };\r\n        }\r\n\r\n        const combineMerge = (target, source, options) => {\r\n          const destination = target.slice();\r\n\r\n          source.forEach((item, index) => {\r\n            if (typeof destination[index] === 'undefined') {\r\n              destination[index] = options.cloneUnlessOtherwiseSpecified(item, options);\r\n            } else if (options.isMergeableObject(item)) {\r\n              destination[index] = deepmerge(target[index], item, options);\r\n            } else if (target.indexOf(item) === -1) {\r\n              destination.push(item);\r\n            }\r\n          });\r\n          return destination;\r\n        };\r\n\r\n        submitCb(\r\n          deepmerge(this._formState.values, this._component.state, {\r\n            arrayMerge: combineMerge\r\n          }),\r\n          handleError\r\n        );\r\n      };\r\n    }\r\n\r\n    this._createFooter = () => (\r\n      <div className=\"ds-toolbar-wrapper\">\r\n        <div className=\"ds-toolbar\">\r\n          <Button\r\n            colorClass={PRIMARY}\r\n            iconClass={ICON.accept}\r\n            onClick={submitHandler(this._component.submit)}\r\n          >\r\n            {lbl}\r\n          </Button>\r\n        </div>\r\n      </div>\r\n    );\r\n  }\r\n\r\n  @autobind\r\n  onChange() {\r\n    this._component.checkCompleteness(this._formState, this._requiredFields);\r\n  }\r\n\r\n  getForm() {\r\n    return (\r\n      <Form onChange={this.onChange}>\r\n        {({ formState, formApi }) => {\r\n          this._formApi = formApi;\r\n          this._formState = formState;\r\n          return this._createForm();\r\n        }}\r\n      </Form>\r\n    );\r\n  }\r\n\r\n  get formApi() {\r\n    return this._formApi;\r\n  }\r\n  get formState() {\r\n    return this._formState;\r\n  }\r\n  get content() {\r\n    return this._content;\r\n  }\r\n  get component() {\r\n    return this._component;\r\n  }\r\n}\r\n\r\nexport default FormBuilder;\r\n"]},"metadata":{},"sourceType":"module"}